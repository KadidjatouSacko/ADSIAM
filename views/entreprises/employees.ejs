<% locals.currentPage = 'employees' %>

<!-- En-t√™te avec actions -->
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
    <div>
        <h2 style="margin: 0; color: var(--text-dark);">Mes Salari√©s</h2>
        <p style="margin: 0.5rem 0 0; color: var(--text-light);">
            G√©rez et suivez la progression de vos √©quipes
        </p>
    </div>
    <div style="display: flex; gap: 1rem;">
        <a href="/entreprise/inscriptions/nouvelle" class="btn btn-primary">
            ‚ûï Inscrire des salari√©s
        </a>
        <button class="btn btn-secondary" onclick="exportEmployeeData()">
            üìä Exporter les donn√©es
        </button>
    </div>
</div>

<!-- Barre de recherche et filtres -->
<div class="card" style="margin-bottom: 2rem;">
    <div class="card-body" style="padding: 1.5rem;">
        <div style="display: grid; grid-template-columns: 1fr auto auto; gap: 1rem; align-items: center;">
            <div style="position: relative;">
                <input type="text" id="searchEmployee" placeholder="Rechercher un salari√©..." 
                       style="width: 100%; padding: 0.75rem 1rem 0.75rem 2.5rem; border: 2px solid var(--soft-gray); border-radius: 8px; font-size: 1rem;">
                <span style="position: absolute; left: 0.75rem; top: 50%; transform: translateY(-50%); color: var(--text-light);">üîç</span>
            </div>
            <select id="filterStatus" style="padding: 0.75rem; border: 2px solid var(--soft-gray); border-radius: 8px;">
                <option value="">Tous les statuts</option>
                <option value="actif">Actifs</option>
                <option value="en_attente">En attente</option>
                <option value="inactif">Inactifs</option>
            </select>
            <select id="filterType" style="padding: 0.75rem; border: 2px solid var(--soft-gray); border-radius: 8px;">
                <option value="">Tous les profils</option>
                <option value="aide_domicile">Aide √† domicile</option>
                <option value="aide_soignant">Aide-soignant</option>
                <option value="infirmier">Infirmier</option>
            </select>
        </div>
    </div>
</div>

<!-- Liste des employ√©s -->
<div class="card">
    <div class="card-header">
        <h3 class="card-title">
            Liste des employ√©s (<%= employees.length %> r√©sultats)
        </h3>
        <div style="display: flex; gap: 0.5rem;">
            <button class="btn btn-secondary" onclick="toggleView('grid')" id="gridViewBtn">
                ‚äû Grille
            </button>
            <button class="btn btn-secondary" onclick="toggleView('table')" id="tableViewBtn">
                ‚ò∞ Tableau
            </button>
        </div>
    </div>
    <div class="card-body" style="padding: 0;">
        <!-- Vue grille -->
        <div id="gridView" class="employee-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 1.5rem; padding: 2rem;">
            <% if (employees && employees.length > 0) { %>
                <% employees.forEach(employee => { %>
                    <div class="employee-card" style="background: var(--soft-gray); padding: 1.5rem; border-radius: 12px; transition: all 0.3s; cursor: pointer;" 
                         onclick="viewEmployeeDetails('<%= employee.id %>')">
                        <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                            <div style="width: 50px; height: 50px; background: var(--gradient-contact); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 1.2rem;">
                                <%= employee.prenom.charAt(0) %><%= employee.nom.charAt(0) %>
                            </div>
                            <div style="flex: 1;">
                                <div style="font-weight: 600; color: var(--text-dark); margin-bottom: 0.25rem;">
                                    <%= employee.prenom %> <%= employee.nom %>
                                </div>
                                <div style="color: var(--text-light); font-size: 0.9rem;">
                                    <%= employee.email %>
                                </div>
                            </div>
                            <span class="badge badge-<%= getStatusBadge(employee.statut) %>">
                                <%= capitalize(employee.statut) %>
                            </span>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                            <div style="text-align: center; padding: 1rem; background: white; border-radius: 8px;">
                                <div style="font-size: 1.5rem; font-weight: 700; color: var(--primary-blue); margin-bottom: 0.25rem;">
                                    <%= employee.nb_formations || 0 %>
                                </div>
                                <div style="font-size: 0.8rem; color: var(--text-light);">Formations</div>
                            </div>
                            <div style="text-align: center; padding: 1rem; background: white; border-radius: 8px;">
                                <div style="font-size: 1.5rem; font-weight: 700; color: var(--success); margin-bottom: 0.25rem;">
                                    <%= employee.formations_terminees || 0 %>
                                </div>
                                <div style="font-size: 0.8rem; color: var(--text-light);">Termin√©es</div>
                            </div>
                        </div>

                        <div style="margin-bottom: 1rem;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                <span style="font-size: 0.9rem; color: var(--text-light);">Progression moyenne</span>
                                <span style="font-weight: 600; color: var(--primary-blue);">
                                    <%= employee.progression_moyenne || 0 %>%
                                </span>
                            </div>
                            <div class="progress">
                                <div class="progress-bar" style="width: <%= employee.progression_moyenne || 0 %>%;"></div>
                            </div>
                        </div>

                        <div style="display: flex; justify-content: space-between; align-items: center; font-size: 0.8rem; color: var(--text-light);">
                            <div>
                                <strong><%= employee.certifications || 0 %></strong> certifications
                            </div>
                            <div>
                                <strong><%= formatDuration(employee.temps_total || 0) %></strong> √©tudi√©es
                            </div>
                        </div>
                    </div>
                <% }) %>
            <% } else { %>
                <div style="grid-column: 1 / -1; text-align: center; padding: 3rem; color: var(--text-light);">
                    Aucun employ√© trouv√©
                </div>
            <% } %>
        </div>

        <!-- Vue tableau -->
        <div id="tableView" style="display: none;">
            <div class="table-container">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Employ√©</th>
                            <th>Contact</th>
                            <th>Profil</th>
                            <th>Statut</th>
                            <th>Formations</th>
                            <th>Progression</th>
                            <th>Certifications</th>
                            <th>Derni√®re connexion</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <% if (employees && employees.length > 0) { %>
                            <% employees.forEach(employee => { %>
                                <tr>
                                    <td>
                                        <div style="display: flex; align-items: center; gap: 0.75rem;">
                                            <div style="width: 35px; height: 35px; background: var(--gradient-contact); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 0.9rem;">
                                                <%= employee.prenom.charAt(0) %><%= employee.nom.charAt(0) %>
                                            </div>
                                            <div>
                                                <div style="font-weight: 600;">
                                                    <%= employee.prenom %> <%= employee.nom %>
                                                </div>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <div><%= employee.email %></div>
                                        <% if (employee.telephone) { %>
                                            <div style="font-size: 0.9rem; color: var(--text-light);">
                                                <%= employee.telephone %>
                                            </div>
                                        <% } %>
                                    </td>
                                    <td>
                                        <span class="badge badge-info">
                                            <%= capitalize(employee.type_utilisateur?.replace('_', ' ') || 'Non d√©fini') %>
                                        </span>
                                    </td>
                                    <td>
                                        <span class="badge badge-<%= getStatusBadge(employee.statut) %>">
                                            <%= capitalize(employee.statut) %>
                                        </span>
                                    </td>
                                    <td>
                                        <div style="text-align: center;">
                                            <div style="font-weight: 600; color: var(--primary-blue);">
                                                <%= employee.formations_terminees || 0 %>/<%= employee.nb_formations || 0 %>
                                            </div>
                                            <div style="font-size: 0.8rem; color: var(--text-light);">
                                                termin√©es
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <div style="min-width: 100px;">
                                            <div style="display: flex; justify-content: space-between; margin-bottom: 0.25rem;">
                                                <span style="font-size: 0.9rem; font-weight: 600;">
                                                    <%= employee.progression_moyenne || 0 %>%
                                                </span>
                                            </div>
                                            <div class="progress">
                                                <div class="progress-bar" style="width: <%= employee.progression_moyenne || 0 %>%;"></div>
                                            </div>
                                        </div>
                                    </td>
                                    <td style="text-align: center;">
                                        <div style="font-weight: 600; color: var(--success);">
                                            <%= employee.certifications || 0 %>
                                        </div>
                                    </td>
                                    <td>
                                        <% if (employee.derniere_connexion) { %>
                                            <div style="font-size: 0.9rem;">
                                                <%= formatDate(employee.derniere_connexion) %>
                                            </div>
                                        <% } else { %>
                                            <span style="color: var(--text-light); font-style: italic;">Jamais</span>
                                        <% } %>
                                    </td>
                                    <td>
                                        <div style="display: flex; gap: 0.5rem;">
                                            <button class="btn btn-secondary" style="padding: 0.5rem; font-size: 0.8rem;" 
                                                    onclick="viewEmployeeDetails('<%= employee.id %>')">
                                                üëÅÔ∏è Voir
                                            </button>
                                            <button class="btn btn-primary" style="padding: 0.5rem; font-size: 0.8rem;" 
                                                    onclick="enrollEmployee('<%= employee.id %>')">
                                                ‚ûï Inscrire
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            <% }) %>
                        <% } else { %>
                            <tr>
                                <td colspan="9" style="text-align: center; padding: 3rem; color: var(--text-light);">
                                    Aucun employ√© trouv√©
                                </td>
                            </tr>
                        <% } %>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Pagination -->
    <% if (pagination && pagination.total > 1) { %>
        <div style="padding: 1.5rem 2rem; border-top: 1px solid var(--soft-gray); display: flex; justify-content: center; align-items: center; gap: 1rem;">
            <% if (pagination.hasPrev) { %>
                <a href="?page=<%= pagination.current - 1 %>" class="btn btn-secondary">
                    ‚Üê Pr√©c√©dent
                </a>
            <% } %>
            
            <span style="color: var(--text-light);">
                Page <%= pagination.current %> sur <%= pagination.total %>
            </span>
            
            <% if (pagination.hasNext) { %>
                <a href="?page=<%= pagination.current + 1 %>" class="btn btn-secondary">
                    Suivant ‚Üí
                </a>
            <% } %>
        </div>
    <% } %>
</div>

<script>
// Recherche en temps r√©el
document.getElementById('searchEmployee').addEventListener('input', function(e) {
    const searchTerm = e.target.value.toLowerCase();
    filterEmployees();
});

// Filtres
document.getElementById('filterStatus').addEventListener('change', filterEmployees);
document.getElementById('filterType').addEventListener('change', filterEmployees);

function filterEmployees() {
    const searchTerm = document.getElementById('searchEmployee').value.toLowerCase();
    const statusFilter = document.getElementById('filterStatus').value;
    const typeFilter = document.getElementById('filterType').value;
    
    const employees = document.querySelectorAll('.employee-card, .table tbody tr');
    
    employees.forEach(employee => {
        const text = employee.textContent.toLowerCase();
        const matchesSearch = text.includes(searchTerm);
        const matchesStatus = !statusFilter || employee.textContent.includes(statusFilter);
        const matchesType = !typeFilter || employee.textContent.includes(typeFilter);
        
        employee.style.display = (matchesSearch && matchesStatus && matchesType) ? '' : 'none';
    });
}

// Basculer entre les vues
function toggleView(view) {
    const gridView = document.getElementById('gridView');
    const tableView = document.getElementById('tableView');
    const gridBtn = document.getElementById('gridViewBtn');
    const tableBtn = document.getElementById('tableViewBtn');
    
    if (view === 'grid') {
        gridView.style.display = 'grid';
        tableView.style.display = 'none';
        gridBtn.classList.add('btn-primary');
        gridBtn.classList.remove('btn-secondary');
        tableBtn.classList.add('btn-secondary');
        tableBtn.classList.remove('btn-primary');
    } else {
        gridView.style.display = 'none';
        tableView.style.display = 'block';
        tableBtn.classList.add('btn-primary');
        tableBtn.classList.remove('btn-secondary');
        gridBtn.classList.add('btn-secondary');
        gridBtn.classList.remove('btn-primary');
    }
    
    localStorage.setItem('employeeViewPreference', view);
}

// Charger la pr√©f√©rence de vue
document.addEventListener('DOMContentLoaded', function() {
    const savedView = localStorage.getItem('employeeViewPreference') || 'grid';
    toggleView(savedView);
});

// Actions
function viewEmployeeDetails(employeeId) {
    window.location.href = `/entreprise/salaries/${employeeId}`;
}

function enrollEmployee(employeeId) {
    window.location.href = `/entreprise/inscriptions/nouvelle?employee=${employeeId}`;
}

function exportEmployeeData() {
    window.location.href = '/entreprise/api/employees/export?format=csv';
}
</script>