<!-- views/entreprises/show.ejs -->
<%- contentFor('head') %>
<style>
    :root {
        --primary-pink: #e7a6b7;
        --primary-blue: #a5bfd4;
        --light-pink: #fce8ec;
        --light-blue: #e8f3f8;
        --soft-gray: #f5f5f7;
        --text-dark: #2f2f2f;
        --text-light: #6f6f6f;
        --white: #ffffff;
        --gradient-contact: linear-gradient(135deg, #e7a6b7, #a5bfd4);
        --success: #9dd6b5;
        --warning: #ff9f80;
        --danger: #ff6b6b;
    }

    .page-header {
        background: var(--gradient-contact);
        color: white;
        padding: 2rem 0;
        margin-bottom: 2rem;
        border-radius: 0 0 25px 25px;
    }

    .header-content {
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 1rem;
    }

    .company-info h1 {
        font-size: 2.5rem;
        margin-bottom: 0.5rem;
    }

    .company-meta {
        opacity: 0.9;
        display: flex;
        gap: 2rem;
        flex-wrap: wrap;
    }

    .actions-header {
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
    }

    .btn {
        padding: 0.75rem 1.5rem;
        border: none;
        border-radius: 10px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
    }

    .btn-light {
        background: rgba(255, 255, 255, 0.2);
        color: white;
        backdrop-filter: blur(10px);
    }

    .btn-light:hover {
        background: rgba(255, 255, 255, 0.3);
        transform: translateY(-2px);
    }

    .status-badge {
        padding: 0.5rem 1rem;
        border-radius: 20px;
        font-weight: 600;
        text-transform: uppercase;
        font-size: 0.9rem;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
    }

    .status-actif {
        background: rgba(157, 214, 181, 0.2);
        color: var(--success);
        border: 2px solid var(--success);
    }

    .status-en_attente {
        background: rgba(255, 159, 128, 0.2);
        color: var(--warning);
        border: 2px solid var(--warning);
    }

    .status-suspendu {
        background: rgba(255, 107, 107, 0.2);
        color: var(--danger);
        border: 2px solid var(--danger);
    }

    .content-grid {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 2rem;
        margin-bottom: 2rem;
    }

    .card {
        background: var(--white);
        border-radius: 15px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.08);
        padding: 2rem;
        margin-bottom: 2rem;
    }

    .card-header {
        display: flex;
        justify-content: between;
        align-items: center;
        margin-bottom: 1.5rem;
        padding-bottom: 1rem;
        border-bottom: 2px solid var(--soft-gray);
    }

    .card-title {
        font-size: 1.4rem;
        font-weight: 600;
        color: var(--primary-blue);
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .info-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1.5rem;
        margin-bottom: 2rem;
    }

    .info-item {
        display: flex;
        flex-direction: column;
    }

    .info-label {
        font-weight: 600;
        color: var(--text-light);
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 0.3rem;
    }

    .info-value {
        color: var(--text-dark);
        font-size: 1.1rem;
    }

    .info-value.large {
        font-size: 1.5rem;
        font-weight: 600;
        color: var(--primary-pink);
    }

    .progress-container {
        margin: 1rem 0;
    }

    .progress-bar {
        width: 100%;
        height: 12px;
        background: var(--soft-gray);
        border-radius: 6px;
        overflow: hidden;
        margin-bottom: 0.5rem;
    }

    .progress-fill {
        height: 100%;
        background: var(--gradient-contact);
        transition: width 0.3s ease;
        border-radius: 6px;
    }

    .progress-text {
        font-size: 0.9rem;
        color: var(--text-light);
        text-align: center;
    }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 1rem;
        margin-bottom: 2rem;
    }

    .stat-item {
        text-align: center;
        padding: 1rem;
        background: var(--light-blue);
        border-radius: 10px;
        border: 2px solid var(--primary-blue);
    }

    .stat-number {
        font-size: 1.8rem;
        font-weight: 700;
        color: var(--primary-blue);
        display: block;
        margin-bottom: 0.3rem;
    }

    .stat-label {
        font-size: 0.8rem;
        color: var(--text-light);
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .users-table {
        overflow-x: auto;
    }

    .table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 1rem;
    }

    .table th,
    .table td {
        padding: 0.75rem;
        text-align: left;
        border-bottom: 1px solid var(--soft-gray);
    }

    .table th {
        background: var(--light-blue);
        font-weight: 600;
        color: var(--text-dark);
    }

    .table tr:hover {
        background: var(--light-pink);
    }

    .user-avatar {
        width: 35px;
        height: 35px;
        border-radius: 50%;
        background: var(--gradient-contact);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 600;
        font-size: 0.9rem;
    }

    .user-info {
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .contract-warning {
        background: rgba(255, 159, 128, 0.1);
        border: 2px solid var(--warning);
        border-radius: 10px;
        padding: 1rem;
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .contract-expired {
        background: rgba(255, 107, 107, 0.1);
        border: 2px solid var(--danger);
    }

    .actions-bottom {
        display: flex;
        gap: 1rem;
        justify-content: center;
        margin-top: 2rem;
    }

    .btn-primary {
        background: var(--gradient-contact);
        color: white;
    }

    .btn-outline {
        background: transparent;
        color: var(--primary-blue);
        border: 2px solid var(--primary-blue);
    }

    .btn-outline:hover {
        background: var(--primary-blue);
        color: white;
    }

    .btn-danger {
        background: var(--danger);
        color: white;
    }

    .dropdown {
        position: relative;
        display: inline-block;
    }

    .dropdown-content {
        display: none;
        position: absolute;
        background: var(--white);
        min-width: 200px;
        box-shadow: 0 8px 30px rgba(0,0,0,0.15);
        border-radius: 10px;
        z-index: 1000;
        right: 0;
        top: 100%;
        margin-top: 0.5rem;
    }

    .dropdown:hover .dropdown-content {
        display: block;
    }

    .dropdown-item {
        color: var(--text-dark);
        padding: 0.75rem 1rem;
        text-decoration: none;
        display: block;
        transition: background 0.2s;
    }

    .dropdown-item:hover {
        background: var(--light-blue);
    }

    @media (max-width: 768px) {
        .content-grid {
            grid-template-columns: 1fr;
        }
        
        .info-grid {
            grid-template-columns: 1fr;
        }
        
        .header-content {
            flex-direction: column;
            align-items: flex-start;
        }
        
        .company-meta {
            flex-direction: column;
            gap: 0.5rem;
        }
    }
</style>

<div class="page-header">
    <div class="container">
        <div class="header-content">
            <div class="company-info">
                <h1><%= entreprise.nom %></h1>
                <div class="company-meta">
                    <span>SIRET: <%= entreprise.siret %></span>
                    <span>üìç <%= entreprise.ville %></span>
                    <span class="status-badge status-<%= entreprise.statut %>">
                        <% if (entreprise.statut === 'actif') { %>‚úÖ<% } %>
                        <% if (entreprise.statut === 'en_attente') { %>‚è≥<% } %>
                        <% if (entreprise.statut === 'suspendu') { %>‚ùå<% } %>
                        <%= entreprise.statut.replace('_', ' ') %>
                    </span>
                </div>
            </div>
            <div class="actions-header">
                <a href="/entreprises" class="btn btn-light">‚Üê Retour</a>
                <a href="/entreprises/<%= entreprise.id %>/modifier" class="btn btn-light">‚úèÔ∏è Modifier</a>
                <a href="/entreprises/<%= entreprise.id %>/dashboard" class="btn btn-light">üìä Dashboard</a>
                <div class="dropdown">
                    <button class="btn btn-light">‚öôÔ∏è Actions ‚ñº</button>
                    <div class="dropdown-content">
                        <a href="#" class="dropdown-item" onclick="changerStatut('<%= entreprise.id %>', 'actif')">‚úÖ Activer</a>
                        <a href="#" class="dropdown-item" onclick="changerStatut('<%= entreprise.id %>', 'suspendu')">‚è∏Ô∏è Suspendre</a>
                        <a href="#" class="dropdown-item" onclick="exporterDonnees('<%= entreprise.id %>')">üìÑ Exporter</a>
                        <a href="#" class="dropdown-item" onclick="supprimerEntreprise('<%= entreprise.id %>', '<%= entreprise.nom %>')">üóëÔ∏è Supprimer</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="container">
    <!-- Alertes de contrat -->
    <% if (entreprise.date_fin_contrat) { %>
        <% const joursRestants = Math.ceil((new Date(entreprise.date_fin_contrat) - new Date()) / (1000 * 60 * 60 * 24)) %>
        <% if (joursRestants <= 0) { %>
            <div class="contract-warning contract-expired">
                <span style="font-size: 1.5rem;">üö®</span>
                <div>
                    <strong>Contrat expir√©</strong><br>
                    Le contrat a expir√© le <%= formatDate(entreprise.date_fin_contrat) %>. Veuillez renouveler rapidement.
                </div>
            </div>
        <% } else if (joursRestants <= 30) { %>
            <div class="contract-warning">
                <span style="font-size: 1.5rem;">‚ö†Ô∏è</span>
                <div>
                    <strong>Contrat expire bient√¥t</strong><br>
                    Le contrat expire dans <%= joursRestants %> jour<%= joursRestants > 1 ? 's' : '' %> (le <%= formatDate(entreprise.date_fin_contrat) %>).
                </div>
            </div>
        <% } %>
    <% } %>

    <div class="content-grid">
        <!-- Colonne principale -->
        <div class="main-content">
            <!-- Informations g√©n√©rales -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">üè¢ Informations g√©n√©rales</h3>
                </div>
                
                <div class="info-grid">
                    <div class="info-item">
                        <span class="info-label">Secteur d'activit√©</span>
                        <span class="info-value">
                            <% const secteurs = {
                                'aide_domicile': 'Aide √† domicile',
                                'ehpad': 'EHPAD',
                                'hopital': 'H√¥pital',
                                'clinique': 'Clinique',
                                'centre_soins': 'Centre de soins',
                                'autre': 'Autre'
                            } %>
                            <%= secteurs[entreprise.secteur_activite] || entreprise.secteur_activite %>
                        </span>
                    </div>
                    
                    <div class="info-item">
                        <span class="info-label">Nombre d'employ√©s</span>
                        <span class="info-value"><%= entreprise.nombre_employes || 'Non renseign√©' %></span>
                    </div>
                    
                    <div class="info-item">
                        <span class="info-label">Email de contact</span>
                        <span class="info-value">
                            <a href="mailto:<%= entreprise.email_contact %>"><%= entreprise.email_contact %></a>
                        </span>
                    </div>
                    
                    <div class="info-item">
                        <span class="info-label">T√©l√©phone</span>
                        <span class="info-value">
                            <% if (entreprise.telephone) { %>
                                <a href="tel:<%= entreprise.telephone %>"><%= entreprise.telephone %></a>
                            <% } else { %>
                                Non renseign√©
                            <% } %>
                        </span>
                    </div>
                    
                    <div class="info-item">
                        <span class="info-label">Site web</span>
                        <span class="info-value">
                            <% if (entreprise.site_web) { %>
                                <a href="<%= entreprise.site_web %>" target="_blank"><%= entreprise.site_web %></a>
                            <% } else { %>
                                Non renseign√©
                            <% } %>
                        </span>
                    </div>
                    
                    <div class="info-item">
                        <span class="info-label">Inscription</span>
                        <span class="info-value"><%= formatDate(entreprise.createdAt) %></span>
                    </div>
                </div>

                <% if (entreprise.description) { %>
                    <div class="info-item">
                        <span class="info-label">Description</span>
                        <span class="info-value"><%= entreprise.description %></span>
                    </div>
                <% } %>
            </div>

            <!-- Adresse et contact -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">üìç Adresse et contact</h3>
                </div>
                
                <div class="info-grid">
                    <div class="info-item" style="grid-column: 1 / -1;">
                        <span class="info-label">Adresse compl√®te</span>
                        <span class="info-value">
                            <%= entreprise.adresse %><br>
                            <%= entreprise.code_postal %> <%= entreprise.ville %>
                        </span>
                    </div>
                    
                    <div class="info-item">
                        <span class="info-label">Personne de contact</span>
                        <span class="info-value">
                            <strong><%= entreprise.personne_contact_prenom %> <%= entreprise.personne_contact_nom %></strong>
                            <% if (entreprise.personne_contact_fonction) { %>
                                <br><small><%= entreprise.personne_contact_fonction %></small>
                            <% } %>
                        </span>
                    </div>
                    
                    <div class="info-item">
                        <span class="info-label">Contact direct</span>
                        <span class="info-value">
                            <a href="mailto:<%= entreprise.personne_contact_email %>"><%= entreprise.personne_contact_email %></a>
                            <% if (entreprise.personne_contact_telephone) { %>
                                <br><a href="tel:<%= entreprise.personne_contact_telephone %>"><%= entreprise.personne_contact_telephone %></a>
                            <% } %>
                        </span>
                    </div>
                </div>
            </div>

            <!-- Utilisateurs de l'entreprise -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">üë• Utilisateurs (<%= utilisateurs.length %>)</h3>
                    <button class="btn btn-primary" onclick="ajouterUtilisateur()">+ Ajouter</button>
                </div>
                
                <% if (utilisateurs.length === 0) { %>
                    <div style="text-align: center; padding: 2rem; color: var(--text-light);">
                        <p>Aucun utilisateur rattach√© √† cette entreprise</p>
                        <button class="btn btn-primary" onclick="ajouterUtilisateur()">Ajouter le premier utilisateur</button>
                    </div>
                <% } else { %>
                    <div class="users-table">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Utilisateur</th>
                                    <th>Type</th>
                                    <th>Statut</th>
                                    <th>Formations</th>
                                    <th>Progression</th>
                                    <th>Derni√®re connexion</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <% utilisateurs.forEach(user => { %>
                                    <tr>
                                        <td>
                                            <div class="user-info">
                                                <div class="user-avatar">
                                                    <%= user.prenom.charAt(0) %><%= user.nom.charAt(0) %>
                                                </div>
                                                <div>
                                                    <strong><%= user.prenom %> <%= user.nom %></strong><br>
                                                    <small><%= user.email %></small>
                                                </div>
                                            </div>
                                        </td>
                                        <td>
                                            <% const types = {
                                                'aide_domicile': 'Aide √† domicile',
                                                'aide_soignant': 'Aide-soignant',
                                                'formateur': 'Formateur',
                                                'etudiant': '√âtudiant'
                                            } %>
                                            <%= types[user.type_utilisateur] || user.type_utilisateur %>
                                        </td>
                                        <td>
                                            <span class="status-badge status-<%= user.statut %>">
                                                <%= user.statut.replace('_', ' ') %>
                                            </span>
                                        </td>
                                        <td><%= user.formations_inscrites || 0 %></td>
                                        <td>
                                            <% const progression = Math.round(user.progression_moyenne || 0) %>
                                            <div class="progress-container">
                                                <div class="progress-bar" style="height: 6px;">
                                                    <div class="progress-fill" style="width: <%= progression %>%"></div>
                                                </div>
                                                <div class="progress-text" style="font-size: 0.8rem;"><%= progression %>%</div>
                                            </div>
                                        </td>
                                        <td>
                                            <% if (user.derniere_connexion_le) { %>
                                                <%= formatDate(user.derniere_connexion_le) %>
                                            <% } else { %>
                                                <span class="text-muted">Jamais</span>
                                            <% } %>
                                        </td>
                                        <td>
                                            <button class="btn btn-outline btn-sm" onclick="retirerUtilisateur('<%= user.id %>', '<%= user.prenom %> <%= user.nom %>')">
                                                üóëÔ∏è
                                            </button>
                                        </td>
                                    </tr>
                                <% }) %>
                            </tbody>
                        </table>
                    </div>
                <% } %>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="sidebar">
            <!-- Statistiques contrat -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">üìä Contrat & Licences</h3>
                </div>
                
                <div class="stats-grid">
                    <div class="stat-item">
                        <span class="stat-number"><%= entreprise.nombre_licences_utilisees %></span>
                        <span class="stat-label">Utilis√©es</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-number"><%= entreprise.nombre_licences_max %></span>
                        <span class="stat-label">Disponibles</span>
                    </div>
                </div>

                <div class="progress-container">
                    <div class="progress-bar">
                        <% const pourcentageUtilisation = entreprise.nombre_licences_max > 0 ? 
                            (entreprise.nombre_licences_utilisees / entreprise.nombre_licences_max) * 100 : 0 %>
                        <div class="progress-fill" style="width: <%= pourcentageUtilisation %>%"></div>
                    </div>
                    <div class="progress-text">
                        <%= Math.round(pourcentageUtilisation) %>% d'utilisation
                    </div>
                </div>

                <div class="info-grid" style="margin-top: 1.5rem;">
                    <div class="info-item">
                        <span class="info-label">Type de contrat</span>
                        <span class="info-value">
                            <% const typeContrats = {
                                'standard': 'ü•â Standard',
                                'premium': 'ü•à Premium',
                                'enterprise': 'ü•á Enterprise',
                                'personnalise': '‚≠ê Personnalis√©'
                            } %>
                            <%= typeContrats[entreprise.type_contrat] || entreprise.type_contrat %>
                        </span>
                    </div>
                    
                    <div class="info-item">
                        <span class="info-label">Tarif mensuel</span>
                        <span class="info-value large">
                            <% if (entreprise.tarif_mensuel) { %>
                                <%= entreprise.tarif_mensuel.toLocaleString('fr-FR') %>‚Ç¨
                            <% } else { %>
                                Gratuit
                            <% } %>
                        </span>
                    </div>
                    
                    <% if (entreprise.reduction_pourcentage > 0) { %>
                        <div class="info-item">
                            <span class="info-label">R√©duction</span>
                            <span class="info-value"><%= entreprise.reduction_pourcentage %>%</span>
                        </div>
                    <% } %>
                    
                    <div class="info-item">
                        <span class="info-label">D√©but contrat</span>
                        <span class="info-value">
                            <% if (entreprise.date_debut_contrat) { %>
                                <%= formatDate(entreprise.date_debut_contrat) %>
                            <% } else { %>
                                Non d√©fini
                            <% } %>
                        </span>
                    </div>
                    
                    <div class="info-item">
                        <span class="info-label">Fin contrat</span>
                        <span class="info-value">
                            <% if (entreprise.date_fin_contrat) { %>
                                <%= formatDate(entreprise.date_fin_contrat) %>
                            <% } else { %>
                                Illimit√©
                            <% } %>
                        </span>
                    </div>
                </div>
            </div>

            <!-- Statistiques d'utilisation -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">üìà Statistiques d'usage</h3>
                </div>
                
                <div class="stats-grid">
                    <div class="stat-item">
                        <span class="stat-number"><%= stats.utilisateurs_actifs || 0 %></span>
                        <span class="stat-label">Utilisateurs actifs</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-number"><%= stats.formations_utilisees || 0 %></span>
                        <span class="stat-label">Formations utilis√©es</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-number"><%= Math.round((stats.temps_total_formation || 0) / 60) %></span>
                        <span class="stat-label">Heures de formation</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-number"><%= stats.certifications_obtenues || 0 %></span>
                        <span class="stat-label">Certifications</span>
                    </div>
                </div>

                <% if (entreprise.derniere_activite) { %>
                    <div class="info-item" style="margin-top: 1rem;">
                        <span class="info-label">Derni√®re activit√©</span>
                        <span class="info-value"><%= formatDate(entreprise.derniere_activite) %></span>
                    </div>
                <% } %>
            </div>

            <!-- Notes internes -->
            <% if (entreprise.notes_internes) { %>
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">üìù Notes internes</h3>
                    </div>
                    <div style="white-space: pre-wrap; color: var(--text-light); font-size: 0.95rem;">
                        <%= entreprise.notes_internes %>
                    </div>
                </div>
            <% } %>
        </div>
    </div>

    <!-- Actions en bas -->
    <div class="actions-bottom">
        <a href="/entreprises/<%= entreprise.id %>/modifier" class="btn btn-primary">
            ‚úèÔ∏è Modifier l'entreprise
        </a>
        <a href="/entreprises/<%= entreprise.id %>/utilisateurs" class="btn btn-outline">
            üë• G√©rer les utilisateurs
        </a>
        <button class="btn btn-outline" onclick="exporterDonnees('<%= entreprise.id %>')">
            üìÑ Exporter les donn√©es
        </button>
        <button class="btn btn-danger" onclick="supprimerEntreprise('<%= entreprise.id %>', '<%= entreprise.nom %>')">
            üóëÔ∏è Supprimer
        </button>
    </div>
</div>

<%- contentFor('scripts') %>
<script>
// Changement de statut
async function changerStatut(id, nouveauStatut) {
    const motif = prompt(`Motif du changement vers "${nouveauStatut}" :`);
    if (motif === null) return;
    
    try {
        const response = await fetch(`/entreprises/${id}/statut`, {
            method: 'PATCH',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ statut: nouveauStatut, motif })
        });
        
        const result = await response.json();
        
        if (result.success) {
            showAlert(result.message, 'success');
            setTimeout(() => window.location.reload(), 1500);
        } else {
            showAlert(result.message, 'error');
        }
    } catch (error) {
        console.error('Erreur changement statut:', error);
        showAlert('Erreur lors du changement de statut', 'error');
    }
}

// Suppression d'entreprise
async function supprimerEntreprise(id, nom) {
    if (!confirm(`ATTENTION : Voulez-vous vraiment supprimer l'entreprise "${nom}" ?\n\nCette action est IRR√âVERSIBLE et supprimera :\n- Toutes les donn√©es de l'entreprise\n- Les liens avec les utilisateurs\n- L'historique des formations\n\nTapez "SUPPRIMER" pour confirmer :`)) {
        return;
    }
    
    const confirmation = prompt('Tapez "SUPPRIMER" en majuscules pour confirmer :');
    if (confirmation !== 'SUPPRIMER') {
        showAlert('Suppression annul√©e', 'info');
        return;
    }
    
    try {
        const response = await fetch(`/entreprises/${id}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        
        const result = await response.json();
        
        if (result.success) {
            showAlert(result.message, 'success');
            setTimeout(() => window.location.href = '/entreprises', 2000);
        } else {
            showAlert(result.message, 'error');
        }
    } catch (error) {
        console.error('Erreur suppression:', error);
        showAlert('Erreur lors de la suppression', 'error');
    }
}

// Ajouter un utilisateur
function ajouterUtilisateur() {
    const email = prompt('Email de l\'utilisateur √† ajouter :');
    if (!email) return;
    
    if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
        showAlert('Format d\'email invalide', 'error');
        return;
    }
    
    ajouterUtilisateurAPI(email);
}

async function ajouterUtilisateurAPI(email) {
    try {
        const response = await fetch(`/entreprises/<%= entreprise.id %>/utilisateurs`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ email_utilisateur: email })
        });
        
        const result = await response.json();
        
        if (result.success) {
            showAlert(result.message, 'success');
            setTimeout(() => window.location.reload(), 1500);
        } else {
            showAlert(result.message, 'error');
        }
    } catch (error) {
        console.error('Erreur ajout utilisateur:', error);
        showAlert('Erreur lors de l\'ajout de l\'utilisateur', 'error');
    }
}

// Retirer un utilisateur
async function retirerUtilisateur(userId, nom) {
    if (!confirm(`Retirer ${nom} de cette entreprise ?\n\nL'utilisateur perdra l'acc√®s aux formations de l'entreprise.`)) {
        return;
    }
    
    try {
        const response = await fetch(`/entreprises/<%= entreprise.id %>/utilisateurs/${userId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        
        const result = await response.json();
        
        if (result.success) {
            showAlert(result.message, 'success');
            setTimeout(() => window.location.reload(), 1500);
        } else {
            showAlert(result.message, 'error');
        }
    } catch (error) {
        console.error('Erreur retrait utilisateur:', error);
        showAlert('Erreur lors du retrait de l\'utilisateur', 'error');
    }
}

// Export des donn√©es
function exporterDonnees(id) {
    const format = prompt('Format d\'export (csv/json) :', 'csv');
    if (!format || !['csv', 'json'].includes(format.toLowerCase())) {
        showAlert('Format non support√©', 'error');
        return;
    }
    
    window.open(`/entreprises/${id}/export/${format.toLowerCase()}`, '_blank');
}

// Fonction d'alerte
function showAlert(message, type) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type}`;
    alertDiv.style.cssText = `
        position: fixed;
        top: 2rem;
        right: 2rem;
        z-index: 9999;
        padding: 1rem 2rem;
        border-radius: 10px;
        color: white;
        font-weight: 600;
        animation: slideInRight 0.3s ease;
        max-width: 400px;
    `;
    
    if (type === 'success') {
        alertDiv.style.background = 'var(--success)';
    } else if (type === 'error') {
        alertDiv.style.background = 'var(--danger)';
    } else if (type === 'info') {
        alertDiv.style.background = 'var(--primary-blue)';
    }
    
    alertDiv.textContent = message;
    document.body.appendChild(alertDiv);
    
    setTimeout(() => {
        alertDiv.style.animation = 'slideOutRight 0.3s ease';
        setTimeout(() => alertDiv.remove(), 300);
    }, 4000);
}

// Animation CSS
const style = document.createElement('style');
style.textContent = `
    @keyframes slideInRight {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }
    @keyframes slideOutRight {
        from { transform: translateX(0); opacity: 1; }
        to { transform: translateX(100%); opacity: 0; }
    }
`;
document.head.appendChild(style);

// Raccourcis clavier
document.addEventListener('keydown', function(e) {
    // E pour √©diter
    if (e.key === 'e' && !e.ctrlKey && !e.metaKey && document.activeElement.tagName !== 'INPUT') {
        window.location.href = `/entreprises/<%= entreprise.id %>/modifier`;
    }
    
    // D pour dashboard
    if (e.key === 'd' && !e.ctrlKey && !e.metaKey && document.activeElement.tagName !== 'INPUT') {
        window.location.href = `/entreprises/<%= entreprise.id %>/dashboard`;
    }
    
    // Escape pour retour
    if (e.key === 'Escape') {
        window.location.href = '/entreprises';
    }
});

console.log('Page d√©tails entreprise charg√©e - <%= entreprise.nom %>');
console.log('Utilisateurs rattach√©s: <%= utilisateurs.length %>');
console.log('Licences utilis√©es: <%= entreprise.nombre_licences_utilisees %>/<%= entreprise.nombre_licences_max %>');
</script>