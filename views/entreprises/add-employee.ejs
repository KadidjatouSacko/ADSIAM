<% locals.currentPage = 'employees' %>

<!-- En-t√™te avec navigation -->
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
    <div>
        <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem; font-size: 0.9rem; color: var(--text-light);">
            <a href="/entreprise/dashboard" style="color: var(--primary-blue); text-decoration: none;">Tableau de bord</a>
            <span>‚Ä∫</span>
            <a href="/entreprise/salaries" style="color: var(--primary-blue); text-decoration: none;">Salari√©s</a>
            <span>‚Ä∫</span>
            <span>Ajouter un salari√©</span>
        </div>
        <h2 style="margin: 0; color: var(--text-dark);">Ajouter un nouveau salari√©</h2>
        <p style="margin: 0.5rem 0 0; color: var(--text-light);">
            Ajoutez un membre de votre √©quipe pour qu'il puisse acc√©der aux formations ADSIAM
        </p>
    </div>
    <a href="/entreprise/salaries" class="btn btn-secondary">
        ‚Üê Retour √† la liste
    </a>
</div>

<!-- Alertes -->
<div id="successAlert" class="alert alert-success" style="display: none; padding: 1rem 1.25rem; border-radius: 10px; margin-bottom: 1.5rem; background: var(--gradient-green); color: white;">
    <strong>Succ√®s !</strong> Le salari√© a √©t√© ajout√© avec succ√®s.
</div>

<div id="errorAlert" class="alert alert-error" style="display: none; padding: 1rem 1.25rem; border-radius: 10px; margin-bottom: 1.5rem; background: linear-gradient(135deg, #ffebee, #f44336); color: white;">
    <strong>Erreur !</strong> <span id="errorMessage">Une erreur est survenue.</span>
</div>

<!-- Formulaire principal -->
<div class="card">
    <form id="addEmployeeForm" novalidate>
        
        <!-- Section 1: Informations personnelles -->
        <div style="margin-bottom: 2.5rem;">
            <h3 style="display: flex; align-items: center; gap: 0.75rem; font-size: 1.3rem; font-weight: 600; color: var(--text-dark); margin-bottom: 1.5rem; padding-bottom: 0.5rem; border-bottom: 2px solid var(--soft-gray);">
                <div style="width: 35px; height: 35px; background: var(--gradient-contact); border-radius: 10px; display: flex; align-items: center; justify-content: center; color: white; font-size: 1.2rem;">
                    üë§
                </div>
                Informations personnelles
            </h3>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
                <div style="display: flex; flex-direction: column;">
                    <label for="prenom" style="font-weight: 600; color: var(--text-dark); margin-bottom: 0.5rem; font-size: 0.95rem;">
                        Pr√©nom <span style="color: #e74c3c;">*</span>
                    </label>
                    <input type="text" id="prenom" name="prenom" required
                           style="padding: 0.875rem 1rem; border: 2px solid var(--soft-gray); border-radius: 10px; font-size: 1rem; transition: all 0.3s; background: var(--white);">
                </div>
                
                <div style="display: flex; flex-direction: column;">
                    <label for="nom" style="font-weight: 600; color: var(--text-dark); margin-bottom: 0.5rem; font-size: 0.95rem;">
                        Nom <span style="color: #e74c3c;">*</span>
                    </label>
                    <input type="text" id="nom" name="nom" required
                           style="padding: 0.875rem 1rem; border: 2px solid var(--soft-gray); border-radius: 10px; font-size: 1rem; transition: all 0.3s; background: var(--white);">
                </div>
                
                <div style="display: flex; flex-direction: column;">
                    <label for="email" style="font-weight: 600; color: var(--text-dark); margin-bottom: 0.5rem; font-size: 0.95rem;">
                        Email professionnel <span style="color: #e74c3c;">*</span>
                    </label>
                    <input type="email" id="email" name="email" required
                           style="padding: 0.875rem 1rem; border: 2px solid var(--soft-gray); border-radius: 10px; font-size: 1rem; transition: all 0.3s; background: var(--white);">
                    <div style="font-size: 0.85rem; color: var(--text-light); margin-top: 0.25rem;">
                        L'email sera utilis√© pour la connexion
                    </div>
                </div>
                
                <div style="display: flex; flex-direction: column;">
                    <label for="telephone" style="font-weight: 600; color: var(--text-dark); margin-bottom: 0.5rem; font-size: 0.95rem;">
                        T√©l√©phone
                    </label>
                    <input type="tel" id="telephone" name="telephone"
                           style="padding: 0.875rem 1rem; border: 2px solid var(--soft-gray); border-radius: 10px; font-size: 1rem; transition: all 0.3s; background: var(--white);">
                </div>
                
                <div style="display: flex; flex-direction: column;">
                    <label for="date_naissance" style="font-weight: 600; color: var(--text-dark); margin-bottom: 0.5rem; font-size: 0.95rem;">
                        Date de naissance
                    </label>
                    <input type="date" id="date_naissance" name="date_naissance"
                           style="padding: 0.875rem 1rem; border: 2px solid var(--soft-gray); border-radius: 10px; font-size: 1rem; transition: all 0.3s; background: var(--white);">
                </div>
                
                <div style="display: flex; flex-direction: column;">
                    <label for="type_utilisateur" style="font-weight: 600; color: var(--text-dark); margin-bottom: 0.5rem; font-size: 0.95rem;">
                        Profil professionnel <span style="color: #e74c3c;">*</span>
                    </label>
                    <select id="type_utilisateur" name="type_utilisateur" required
                            style="padding: 0.875rem 1rem; border: 2px solid var(--soft-gray); border-radius: 10px; font-size: 1rem; background: var(--white); cursor: pointer;">
                        <option value="">S√©lectionnez un profil</option>
                        <option value="aide_domicile">Aide √† domicile</option>
                        <option value="aide_soignant">Aide-soignant</option>
                        <option value="infirmier">Infirmier</option>
                        <option value="auxiliaire_vie">Auxiliaire de vie</option>
                        <option value="responsable_equipe">Responsable d'√©quipe</option>
                        <option value="autre">Autre</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Section 2: Informations professionnelles -->
        <div style="margin-bottom: 2.5rem;">
            <h3 style="display: flex; align-items: center; gap: 0.75rem; font-size: 1.3rem; font-weight: 600; color: var(--text-dark); margin-bottom: 1.5rem; padding-bottom: 0.5rem; border-bottom: 2px solid var(--soft-gray);">
                <div style="width: 35px; height: 35px; background: var(--gradient-contact); border-radius: 10px; display: flex; align-items: center; justify-content: center; color: white; font-size: 1.2rem;">
                    üíº
                </div>
                Informations professionnelles
            </h3>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
                <div style="display: flex; flex-direction: column;">
                    <label for="statut" style="font-weight: 600; color: var(--text-dark); margin-bottom: 0.5rem; font-size: 0.95rem;">
                        Statut <span style="color: #e74c3c;">*</span>
                    </label>
                    <select id="statut" name="statut" required
                            style="padding: 0.875rem 1rem; border: 2px solid var(--soft-gray); border-radius: 10px; font-size: 1rem; background: var(--white); cursor: pointer;">
                        <option value="actif">Actif</option>
                        <option value="en_attente">En attente d'activation</option>
                        <option value="inactif">Inactif</option>
                    </select>
                </div>
                
                <div style="display: flex; flex-direction: column;">
                    <label for="role" style="font-weight: 600; color: var(--text-dark); margin-bottom: 0.5rem; font-size: 0.95rem;">
                        R√¥le dans le syst√®me <span style="color: #e74c3c;">*</span>
                    </label>
                    <select id="role" name="role" required
                            style="padding: 0.875rem 1rem; border: 2px solid var(--soft-gray); border-radius: 10px; font-size: 1rem; background: var(--white); cursor: pointer;">
                        <option value="employe">Employ√©</option>
                        <option value="formateur">Formateur</option>
                        <option value="manager">Manager</option>
                    </select>
                </div>
                
                <div style="display: flex; flex-direction: column;">
                    <label for="mot_de_passe" style="font-weight: 600; color: var(--text-dark); margin-bottom: 0.5rem; font-size: 0.95rem;">
                        Mot de passe temporaire <span style="color: #e74c3c;">*</span>
                    </label>
                    <input type="password" id="mot_de_passe" name="mot_de_passe" required
                           style="padding: 0.875rem 1rem; border: 2px solid var(--soft-gray); border-radius: 10px; font-size: 1rem; transition: all 0.3s; background: var(--white);">
                    <div style="font-size: 0.85rem; color: var(--text-light); margin-top: 0.25rem;">
                        Le salari√© devra changer ce mot de passe √† la premi√®re connexion
                    </div>
                </div>
                
                <div style="display: flex; flex-direction: column;">
                    <label for="confirm_password" style="font-weight: 600; color: var(--text-dark); margin-bottom: 0.5rem; font-size: 0.95rem;">
                        Confirmer le mot de passe <span style="color: #e74c3c;">*</span>
                    </label>
                    <input type="password" id="confirm_password" name="confirm_password" required
                           style="padding: 0.875rem 1rem; border: 2px solid var(--soft-gray); border-radius: 10px; font-size: 1rem; transition: all 0.3s; background: var(--white);">
                </div>
            </div>
        </div>

        <!-- Section 3: Aper√ßu du profil -->
        <div style="margin-bottom: 2.5rem;">
            <h3 style="display: flex; align-items: center; gap: 0.75rem; font-size: 1.3rem; font-weight: 600; color: var(--text-dark); margin-bottom: 1.5rem; padding-bottom: 0.5rem; border-bottom: 2px solid var(--soft-gray);">
                <div style="width: 35px; height: 35px; background: var(--gradient-contact); border-radius: 10px; display: flex; align-items: center; justify-content: center; color: white; font-size: 1.2rem;">
                    üëÅÔ∏è
                </div>
                Aper√ßu du profil
            </h3>
            
            <div style="display: flex; align-items: center; gap: 1rem; padding: 1rem; background: var(--light-blue); border-radius: 10px;">
                <div id="avatarPreview" style="width: 60px; height: 60px; background: var(--gradient-contact); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 700; font-size: 1.5rem;">
                    ?
                </div>
                <div>
                    <h4 id="namePreview" style="font-weight: 600; margin-bottom: 0.25rem;">Pr√©nom Nom</h4>
                    <p id="emailPreview" style="color: var(--text-light); font-size: 0.9rem; margin-bottom: 0.25rem;">email@exemple.com</p>
                    <p id="rolePreview" style="color: var(--text-light); font-size: 0.9rem;">Profil professionnel</p>
                </div>
            </div>
        </div>

        <!-- Boutons -->
        <div style="display: flex; gap: 1rem; justify-content: flex-end; padding-top: 2rem; border-top: 1px solid var(--soft-gray);">
            <a href="/entreprise/salaries" class="btn btn-secondary">
                ‚Üê Annuler
            </a>
            <button type="submit" class="btn btn-primary" id="submitBtn">
                üíæ Ajouter le salari√©
            </button>
        </div>
    </form>
</div>

<script>
// Variables globales
const form = document.getElementById('addEmployeeForm');
const submitBtn = document.getElementById('submitBtn');
const successAlert = document.getElementById('successAlert');
const errorAlert = document.getElementById('errorAlert');
const errorMessage = document.getElementById('errorMessage');

// √âl√©ments de l'aper√ßu
const avatarPreview = document.getElementById('avatarPreview');
const namePreview = document.getElementById('namePreview');
const emailPreview = document.getElementById('emailPreview');
const rolePreview = document.getElementById('rolePreview');

// Mise √† jour de l'aper√ßu en temps r√©el
function updatePreview() {
    const prenom = document.getElementById('prenom').value || 'Pr√©nom';
    const nom = document.getElementById('nom').value || 'Nom';
    const email = document.getElementById('email').value || 'email@exemple.com';
    const typeUtilisateur = document.getElementById('type_utilisateur').value;

    // Mise √† jour de l'avatar
    if (prenom && nom && prenom !== 'Pr√©nom' && nom !== 'Nom') {
        avatarPreview.textContent = prenom.charAt(0).toUpperCase() + nom.charAt(0).toUpperCase();
    } else {
        avatarPreview.textContent = '?';
    }

    // Mise √† jour des informations
    namePreview.textContent = `${prenom} ${nom}`;
    emailPreview.textContent = email;
    
    const typeLabels = {
        'aide_domicile': 'Aide √† domicile',
        'aide_soignant': 'Aide-soignant',
        'infirmier': 'Infirmier',
        'auxiliaire_vie': 'Auxiliaire de vie',
        'responsable_equipe': 'Responsable d\'√©quipe',
        'autre': 'Autre'
    };
    rolePreview.textContent = typeLabels[typeUtilisateur] || 'Profil professionnel';
}

// √âcouteurs pour la mise √† jour de l'aper√ßu
['prenom', 'nom', 'email', 'type_utilisateur'].forEach(id => {
    document.getElementById(id).addEventListener('input', updatePreview);
});

// Validation en temps r√©el
function validateField(field) {
    const value = field.value.trim();
    const isValid = field.checkValidity();
    
    if (isValid && value) {
        field.style.borderColor = 'var(--primary-blue)';
    } else if (!isValid || (field.required && !value)) {
        field.style.borderColor = '#e74c3c';
    } else {
        field.style.borderColor = 'var(--soft-gray)';
    }
    
    return isValid;
}

// Validation du mot de passe
function validatePasswords() {
    const password = document.getElementById('mot_de_passe').value;
    const confirmPassword = document.getElementById('confirm_password').value;
    const confirmField = document.getElementById('confirm_password');
    
    if (password && confirmPassword && password !== confirmPassword) {
        confirmField.style.borderColor = '#e74c3c';
        return false;
    } else if (password && confirmPassword && password === confirmPassword) {
        confirmField.style.borderColor = 'var(--primary-blue)';
        return true;
    }
    return true;
}

// Validation de l'email
function validateEmail() {
    const email = document.getElementById('email').value;
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    const emailField = document.getElementById('email');
    
    if (email && !emailRegex.test(email)) {
        emailField.style.borderColor = '#e74c3c';
        return false;
    } else if (email && emailRegex.test(email)) {
        emailField.style.borderColor = 'var(--primary-blue)';
        return true;
    }
    return true;
}

// Focus styles
document.querySelectorAll('.form-input, .form-select, input, select').forEach(field => {
    field.addEventListener('focus', function() {
        this.style.borderColor = 'var(--primary-blue)';
        this.style.boxShadow = '0 0 0 3px rgba(165, 191, 212, 0.2)';
    });
    
    field.addEventListener('blur', function() {
        this.style.boxShadow = 'none';
        validateField(this);
        if (this.id === 'email') validateEmail();
        if (this.id === 'confirm_password' || this.id === 'mot_de_passe') validatePasswords();
    });
    
    field.addEventListener('input', function() {
        if (this.id === 'email') validateEmail();
        if (this.id === 'confirm_password' || this.id === 'mot_de_passe') validatePasswords();
    });
});

// Affichage des alertes
function showAlert(type, message) {
    hideAlerts();
    
    if (type === 'success') {
        successAlert.style.display = 'block';
    } else {
        errorMessage.textContent = message;
        errorAlert.style.display = 'block';
    }
    
    // Scroll vers le haut pour voir l'alerte
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

function hideAlerts() {
    successAlert.style.display = 'none';
    errorAlert.style.display = 'none';
}

// Soumission du formulaire
form.addEventListener('submit', async function(e) {
    e.preventDefault();
    hideAlerts();

    // Validation compl√®te
    const formData = new FormData(form);
    const data = Object.fromEntries(formData);

    // V√©rifications
    if (!data.prenom || !data.nom || !data.email) {
        showAlert('error', 'Veuillez remplir tous les champs obligatoires.');
        return;
    }

    if (!validateEmail()) {
        showAlert('error', 'Veuillez entrer une adresse email valide.');
        return;
    }

    if (!validatePasswords()) {
        showAlert('error', 'Les mots de passe ne correspondent pas.');
        return;
    }

    if (data.mot_de_passe.length < 6) {
        showAlert('error', 'Le mot de passe doit contenir au moins 6 caract√®res.');
        return;
    }

    // Changement du bouton
    submitBtn.disabled = true;
    submitBtn.innerHTML = '‚è≥ Ajout en cours...';

    try {
        const response = await fetch('/entreprise/salaries/nouveau', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        });

        const result = await response.json();

        if (response.ok) {
            showAlert('success', 'Le salari√© a √©t√© ajout√© avec succ√®s !');
            
            // Redirection apr√®s 2 secondes
            setTimeout(() => {
                window.location.href = '/entreprise/salaries';
            }, 2000);
            
        } else {
            showAlert('error', result.message || 'Une erreur est survenue lors de l\'ajout.');
        }
    } catch (error) {
        console.error('Erreur:', error);
        showAlert('error', 'Erreur de connexion. Veuillez r√©essayer.');
    } finally {
        submitBtn.disabled = false;
        submitBtn.innerHTML = 'üíæ Ajouter le salari√©';
    }
});

// Initialisation
updatePreview();
</script>