<!-- views/admin/users/list.ejs -->
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title %></title>
    <link rel="stylesheet" href="/css/admin.css">
</head>
<body>
    <div class="admin-layout">
        <!-- Sidebar -->
        <nav class="sidebar">
            <div class="sidebar-header">
                <h2>ADSIAM Admin</h2>
            </div>
            <ul class="sidebar-menu">
                <li><a href="/admin" class="<%= currentPage === 'dashboard' ? 'active' : '' %>">📊 Tableau de bord</a></li>
                <li><a href="/admin/utilisateurs" class="<%= currentPage === 'users' ? 'active' : '' %>">👥 Utilisateurs</a></li>
                <li><a href="/admin/formations" class="<%= currentPage === 'formations' ? 'active' : '' %>">📚 Formations</a></li>
                <li><a href="/admin/inscriptions" class="<%= currentPage === 'inscriptions' ? 'active' : '' %>">📝 Inscriptions</a></li>
                <li><a href="/admin/evenements" class="<%= currentPage === 'events' ? 'active' : '' %>">📅 Événements</a></li>
                <li><a href="/admin/rapports">📊 Rapports</a></li>
                <li><a href="/admin/messagerie">💬 Messagerie</a></li>
                <li><a href="/admin/parametres">⚙️ Paramètres</a></li>
            </ul>
        </nav>

        <!-- Main Content -->
        <main class="main-content">
            <div class="content-header">
                <h1>Gestion des utilisateurs</h1>
                <div class="header-actions">
                    <a href="/admin/utilisateurs/nouveau" class="btn btn-primary">➕ Nouvel utilisateur</a>
                </div>
            </div>

            <!-- Filtres -->
            <div class="filters-section">
                <form class="filters-form" method="GET">
                    <div class="filter-group">
                        <input type="text" name="search" placeholder="Rechercher..." value="<%= filters.search %>" class="form-input">
                    </div>
                    <div class="filter-group">
                        <select name="role" class="form-select">
                            <option value="">Tous les rôles</option>
                            <option value="apprenant" <%= filters.role === 'apprenant' ? 'selected' : '' %>>Apprenant</option>
                            <option value="formateur" <%= filters.role === 'formateur' ? 'selected' : '' %>>Formateur</option>
                            <option value="admin" <%= filters.role === 'admin' ? 'selected' : '' %>>Admin</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <select name="statut" class="form-select">
                            <option value="">Tous les statuts</option>
                            <option value="actif" <%= filters.statut === 'actif' ? 'selected' : '' %>>Actif</option>
                            <option value="inactif" <%= filters.statut === 'inactif' ? 'selected' : '' %>>Inactif</option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-secondary">Filtrer</button>
                </form>
            </div>

            <!-- Liste des utilisateurs -->
            <div class="table-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Nom complet</th>
                            <th>Email</th>
                            <th>Rôle</th>
                            <th>Statut</th>
                            <th>Date d'inscription</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <% users.forEach(user => { %>
                        <tr>
                            <td><%= user.id %></td>
                            <td><%= user.prenom %> <%= user.nom %></td>
                            <td><%= user.email %></td>
                            <td>
                                <span class="badge badge-<%= user.role %>"><%= user.role %></span>
                            </td>
                            <td>
                                <span class="status status-<%= user.statut %>"><%= user.statut %></span>
                            </td>
                            <td><%= new Date(user.createdAt).toLocaleDateString('fr-FR') %></td>
                            <td class="actions">
                                <a href="/admin/utilisateurs/<%= user.id %>/modifier" class="btn-icon" title="Modifier">✏️</a>
                                <button onclick="toggleUserStatus(<%= user.id %>)" class="btn-icon" title="Changer statut">🔄</button>
                                <button onclick="deleteUser(<%= user.id %>)" class="btn-icon btn-danger" title="Supprimer">🗑️</button>
                            </td>
                        </tr>
                        <% }); %>
                    </tbody>
                </table>
            </div>

            <!-- Pagination -->
            <div class="pagination-container">
                <div class="pagination-info">
                    Affichage de <%= (pagination.currentPage - 1) * 20 + 1 %> à <%= Math.min(pagination.currentPage * 20, pagination.total) %> sur <%= pagination.total %> utilisateurs
                </div>
                <div class="pagination">
                    <% if (pagination.hasPrev) { %>
                        <a href="?page=<%= pagination.currentPage - 1 %>" class="btn btn-pagination">← Précédent</a>
                    <% } %>
                    
                    <% for (let i = Math.max(1, pagination.currentPage - 2); i <= Math.min(pagination.totalPages, pagination.currentPage + 2); i++) { %>
                        <a href="?page=<%= i %>" class="btn btn-pagination <%= i === pagination.currentPage ? 'active' : '' %>"><%= i %></a>
                    <% } %>
                    
                    <% if (pagination.hasNext) { %>
                        <a href="?page=<%= pagination.currentPage + 1 %>" class="btn btn-pagination">Suivant →</a>
                    <% } %>
                </div>
            </div>
        </main>
    </div>

    <script>
        function toggleUserStatus(userId) {
            if (confirm('Changer le statut de cet utilisateur ?')) {
                fetch(`/admin/api/utilisateurs/${userId}/toggle-status`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        location.reload();
                    } else {
                        alert('Erreur: ' + data.error);
                    }
                });
            }
        }

        function deleteUser(userId) {
            if (confirm('Êtes-vous sûr de vouloir supprimer cet utilisateur ?')) {
                fetch(`/admin/utilisateurs/${userId}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        location.reload();
                    } else {
                        alert('Erreur: ' + data.error);
                    }
                });
            }
        }
    </script>
</body>
</html>
