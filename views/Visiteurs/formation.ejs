<!-- views/visiteurs/formation.ejs -->
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= formation.titre %> | ADSIAM - Formation D√©taill√©e</title>
    <meta name="description" content="<%= formation.description.substring(0, 160) %>">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-pink: #e7a6b7;
            --primary-blue: #a5bfd4;
            --light-pink: #fce8ec;
            --light-blue: #e8f3f8;
            --soft-gray: #f5f5f7;
            --text-dark: #2f2f2f;
            --text-light: #6f6f6f;
            --white: #ffffff;
            --success: #10b981;
            --warning: #f59e0b;
            --gradient-main: linear-gradient(135deg, var(--primary-pink), var(--primary-blue));
            --shadow-light: 0 4px 20px rgba(0,0,0,0.05);
            --shadow-medium: 0 8px 30px rgba(0,0,0,0.1);
            --shadow-heavy: 0 20px 60px rgba(0,0,0,0.15);
            --border-radius: 16px;
            --border-radius-lg: 24px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            line-height: 1.6;
            color: var(--text-dark);
            min-height: 100vh;
        }

        /* Breadcrumb am√©lior√© */
        .breadcrumb {
            background: var(--white);
            padding: 1rem 0;
            border-bottom: 1px solid #e2e8f0;
            position: sticky;
            top: 0;
            z-index: 50;
            backdrop-filter: blur(10px);
        }

        .breadcrumb-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 1rem;
        }

        .breadcrumb-nav {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
            flex-wrap: wrap;
        }

        .breadcrumb-nav a {
            color: var(--text-light);
            text-decoration: none;
            transition: color 0.3s;
            padding: 0.25rem 0.5rem;
            border-radius: 6px;
        }

        .breadcrumb-nav a:hover {
            color: var(--primary-blue);
            background: var(--light-blue);
        }

        .breadcrumb-separator {
            color: var(--text-light);
            margin: 0 0.25rem;
        }

        .breadcrumb-current {
            color: var(--primary-pink);
            font-weight: 500;
            padding: 0.25rem 0.5rem;
            background: var(--light-pink);
            border-radius: 6px;
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        /* Container principal responsive */
        .formation-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 1rem;
            display: grid;
            grid-template-columns: 1fr;
            gap: 2rem;
        }

        /* Header de formation modernis√© */
        .formation-header {
            background: var(--white);
            border-radius: var(--border-radius-lg);
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: var(--shadow-medium);
            position: relative;
            overflow: hidden;
        }

        .formation-header::before {
            content: '';
            position: absolute;
            top: -30%;
            right: -20%;
            width: 40%;
            height: 160%;
            background: var(--gradient-main);
            border-radius: 50%;
            opacity: 0.05;
            transform: rotate(-15deg);
        }

        .formation-hero {
            position: relative;
            z-index: 2;
            display: grid;
            grid-template-columns: 1fr;
            gap: 2rem;
            align-items: start;
        }

        .formation-info {
            text-align: center;
        }

        .formation-title {
            font-size: clamp(1.8rem, 4vw, 2.8rem);
            font-weight: 700;
            color: var(--text-dark);
            margin-bottom: 1rem;
            line-height: 1.2;
        }

        .formation-subtitle {
            font-size: 1.1rem;
            color: var(--primary-blue);
            margin-bottom: 1.5rem;
            font-weight: 500;
        }

        .formation-description {
            font-size: 1rem;
            color: var(--text-light);
            line-height: 1.7;
            margin-bottom: 2rem;
            max-width: 100%;
        }

        .formation-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
            margin-bottom: 2rem;
            justify-content: center;
        }

        .meta-badge {
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            white-space: nowrap;
        }

        .formation-icon-large {
            width: 120px;
            height: 120px;
            background: var(--gradient-main);
            border-radius: var(--border-radius-lg);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            color: white;
            margin: 0 auto 1.5rem;
            box-shadow: var(--shadow-medium);
        }

        /* Contenu responsive */
        .content-column {
            width: 100%;
        }

        .course-content {
            background: var(--white);
            border-radius: var(--border-radius-lg);
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: var(--shadow-light);
        }

        .section-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }

        .section-icon {
            width: 48px;
            height: 48px;
            background: var(--gradient-main);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.3rem;
            flex-shrink: 0;
        }

        .section-title {
            font-size: clamp(1.3rem, 3vw, 1.8rem);
            font-weight: 600;
            color: var(--text-dark);
            margin: 0;
        }

        /* Modules am√©lior√©s pour mobile */
        .modules-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .module-item {
            background: var(--soft-gray);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            border: 2px solid transparent;
            position: relative;
        }

        .module-item:hover {
            background: var(--white);
            border-color: var(--primary-blue);
            box-shadow: var(--shadow-medium);
            transform: translateY(-2px);
        }

        .module-item.locked {
            opacity: 0.7;
            cursor: not-allowed;
        }

        .module-item.locked:hover {
            transform: none;
            box-shadow: none;
        }

        .module-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
            gap: 1rem;
        }

        .module-title-group {
            display: flex;
            align-items: flex-start;
            gap: 1rem;
            flex: 1;
            min-width: 0;
        }

        .module-number {
            width: 32px;
            height: 32px;
            background: var(--gradient-main);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 0.9rem;
            flex-shrink: 0;
        }

        .module-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-dark);
            margin: 0;
            line-height: 1.3;
            word-break: break-word;
        }

        .module-status {
            padding: 0.3rem 0.8rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            white-space: nowrap;
            flex-shrink: 0;
        }

        .module-status.available {
            background: #dcfce7;
            color: var(--success);
        }

        .module-status.locked {
            background: #fef2f2;
            color: #dc2626;
        }

        .module-description {
            color: var(--text-light);
            margin-bottom: 1rem;
            line-height: 1.6;
            font-size: 0.95rem;
        }

        .module-details {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            font-size: 0.85rem;
            color: var(--text-light);
        }

        .module-detail {
            display: flex;
            align-items: center;
            gap: 0.4rem;
        }

        .module-detail-icon {
            color: var(--primary-blue);
            font-size: 1rem;
        }

        /* Sidebar sticky pour desktop */
        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 2rem;
        }

        .purchase-card {
            background: var(--white);
            border-radius: var(--border-radius-lg);
            padding: 2rem;
            box-shadow: var(--shadow-medium);
            border: 1px solid #e2e8f0;
        }

        .price-section {
            text-align: center;
            margin-bottom: 2rem;
            padding-bottom: 2rem;
            border-bottom: 2px solid var(--soft-gray);
        }

        .price-current {
            font-size: clamp(2rem, 5vw, 3rem);
            font-weight: 800;
            color: var(--primary-pink);
            display: block;
            line-height: 1;
        }

        .price-badge {
            display: inline-block;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            margin-top: 1rem;
        }

        .price-badge.free {
            background: var(--success);
            color: white;
        }

        .price-badge.discount {
            background: var(--success);
            color: white;
        }

        .features-list {
            list-style: none;
            margin-bottom: 2rem;
        }

        .feature-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 0.75rem;
            font-size: 0.9rem;
        }

        .feature-check {
            width: 22px;
            height: 22px;
            background: var(--success);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.7rem;
            flex-shrink: 0;
            font-weight: 700;
        }

        /* Boutons CTA am√©lior√©s */
        .cta-buttons {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .btn {
            padding: 1rem 1.5rem;
            border: none;
            border-radius: var(--border-radius);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-size: 1rem;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            text-decoration: none;
        }

        .btn-primary {
            background: var(--gradient-main);
            color: white;
            box-shadow: var(--shadow-light);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-heavy);
        }

        .btn-secondary {
            background: transparent;
            color: var(--primary-blue);
            border: 2px solid var(--primary-blue);
        }

        .btn-secondary:hover {
            background: var(--primary-blue);
            color: white;
        }

        /* Stats card */
        .stats-card {
            background: var(--white);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            box-shadow: var(--shadow-light);
            text-align: center;
        }

        .stats-grid {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 0;
            border-bottom: 1px solid var(--soft-gray);
        }

        .stat-row:last-child {
            border-bottom: none;
        }

        .stat-label {
            color: var(--text-light);
            font-size: 0.9rem;
        }

        .stat-value {
            font-weight: 600;
            color: var(--text-dark);
        }

        /* Avis section */
        .reviews-section {
            background: var(--white);
            border-radius: var(--border-radius-lg);
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: var(--shadow-light);
        }

        .reviews-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .rating-overview {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .rating-score {
            font-size: clamp(2rem, 4vw, 3rem);
            font-weight: 800;
            color: var(--primary-pink);
        }

        .rating-details {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .stars {
            color: #fbbf24;
            font-size: 1.3rem;
        }

        .rating-count {
            color: var(--text-light);
            font-size: 0.85rem;
        }

        .review-item {
            background: var(--soft-gray);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            margin-bottom: 1rem;
        }

        .review-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
            gap: 1rem;
        }

        .reviewer-info {
            display: flex;
            align-items: center;
            gap: 1rem;
            min-width: 0;
            flex: 1;
        }

        .reviewer-avatar {
            width: 40px;
            height: 40px;
            background: var(--gradient-main);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 0.9rem;
            flex-shrink: 0;
        }

        .reviewer-details h4 {
            color: var(--text-dark);
            font-size: 1rem;
            margin: 0 0 0.2rem 0;
            font-weight: 600;
        }

        .reviewer-role {
            color: var(--text-light);
            font-size: 0.85rem;
            margin: 0;
        }

        .review-rating {
            color: #fbbf24;
            font-size: 1.1rem;
            flex-shrink: 0;
        }

        .review-text {
            color: var(--text-light);
            line-height: 1.6;
            font-style: italic;
        }

        /* Formations similaires */
        .similar-formations {
            background: var(--white);
            border-radius: var(--border-radius-lg);
            padding: 2rem;
            box-shadow: var(--shadow-light);
        }

        .similar-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
        }

        .similar-card {
            background: var(--soft-gray);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            text-align: center;
            transition: all 0.3s;
            cursor: pointer;
            border: 2px solid transparent;
        }

        .similar-card:hover {
            background: var(--white);
            border-color: var(--primary-blue);
            box-shadow: var(--shadow-medium);
            transform: translateY(-4px);
        }

        .similar-icon {
            width: 60px;
            height: 60px;
            background: var(--gradient-main);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1rem;
            font-size: 1.8rem;
            color: white;
        }

        .similar-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 0.5rem;
            line-height: 1.3;
        }

        .similar-price {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--primary-pink);
        }

        /* √âtat vide */
        .empty-state {
            text-align: center;
            padding: 3rem 1rem;
            background: var(--soft-gray);
            border-radius: var(--border-radius);
            color: var(--text-light);
        }

        .empty-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.7;
        }

        /* Responsive Design */
        @media (min-width: 768px) {
            .formation-container {
                padding: 2rem;
                grid-template-columns: 2fr 1fr;
                gap: 3rem;
            }

            .formation-header {
                padding: 3rem;
            }

            .formation-hero {
                grid-template-columns: 1fr auto;
                text-align: left;
            }

            .formation-info {
                text-align: left;
            }

            .formation-meta {
                justify-content: flex-start;
            }

            .formation-icon-large {
                margin: 0;
            }

            .course-content {
                padding: 2.5rem;
            }

            .purchase-card {
                position: sticky;
                top: 2rem;
            }

            .module-header {
                align-items: center;
            }

            .stats-grid {
                flex-direction: column;
            }

            .breadcrumb-current {
                max-width: none;
            }
        }

        @media (min-width: 1024px) {
            .formation-container {
                padding: 3rem 2rem;
            }

            .similar-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        /* Animations */
        .fade-in {
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.6s ease, transform 0.6s ease;
        }

        .fade-in.visible {
            opacity: 1;
            transform: translateY(0);
        }

        /* √âtats de loading */
        .loading {
            position: relative;
            pointer-events: none;
            opacity: 0.7;
        }

        .loading::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 20px;
            height: 20px;
            margin: -10px 0 0 -10px;
            border: 2px solid var(--primary-blue);
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Accessibilit√© */
        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

        .visually-hidden {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        /* Focus styles */
        .btn:focus-visible,
        .module-item:focus-visible,
        .similar-card:focus-visible {
            outline: 2px solid var(--primary-blue);
            outline-offset: 2px;
        }
    </style>
</head>
<body>
    <%- include('../partials/header') %>
    
    <!-- Breadcrumb -->
    <div class="breadcrumb">
        <div class="breadcrumb-container">
            <nav class="breadcrumb-nav" aria-label="Fil d'Ariane">
                <a href="/">üè† Accueil</a>
                <span class="breadcrumb-separator" aria-hidden="true">‚Ä∫</span>
                <a href="/formations">Formations</a>
                <span class="breadcrumb-separator" aria-hidden="true">‚Ä∫</span>
                <span class="breadcrumb-current"><%= formation.titre %></span>
            </nav>
        </div>
    </div>

    <div class="formation-container">
        <!-- Contenu principal -->
        <div class="content-column">
            <!-- En-t√™te de la formation -->
            <div class="formation-header fade-in">
                <div class="formation-hero">
                    <div class="formation-info">
                        <h1 class="formation-title"><%= formation.titre %></h1>
                        <p class="formation-subtitle">
                            Formation <%= formation.niveau %> ‚Ä¢ 
                            <%= formation.duree_heures %> heures ‚Ä¢ 
                            <%= formation.nombre_modules %> modules
                        </p>
                        <p class="formation-description"><%= formation.description %></p>
                        
                        <div class="formation-meta">
                            <div class="meta-badge" style="background: var(--light-blue); color: var(--primary-blue);">
                                üìö Niveau <%= formation.niveau %>
                            </div>
                            <div class="meta-badge" style="background: var(--light-pink); color: var(--primary-pink);">
                                ‚è±Ô∏è <%= formation.duree_heures %>h
                            </div>
                            <div class="meta-badge" style="background: var(--soft-gray); color: var(--text-dark);">
                                üéØ <%= formation.nombre_modules %> modules
                            </div>
                            <% if (formation.nombreAvis && formation.nombreAvis > 0) { %>
                            <div class="meta-badge" style="background: #fef3c7; color: #d97706;">
                                ‚≠ê <%= formation.noteMoyenne %>/5 (<%= formation.nombreAvis %>)
                            </div>
                            <% } %>
                            <% if (formation.certifiant) { %>
                            <div class="meta-badge" style="background: #f3e8ff; color: #7c3aed;">
                                üèÜ Certifiante
                            </div>
                            <% } %>
                        </div>
                    </div>
                    <div class="formation-icon-large">
                        <%= formation.icone || 'üìö' %>
                    </div>
                </div>
            </div>

            <!-- Contenu du cours -->
            <div class="course-content fade-in">
                <div class="section-header">
                    <div class="section-icon">üìã</div>
                    <h2 class="section-title">Contenu de la formation</h2>
                </div>
                
                <div class="modules-list">
                    <% if (formation.modules && formation.modules.length > 0) { %>
                        <% formation.modules.forEach((module, index) => { %>
                        <div class="module-item <%= !module.disponible ? 'locked' : '' %>" 
                             onclick="ouvrirModule(<%= module.id %>, '<%= module.titre.replace(/'/g, "\\'") %>', <%= module.disponible %>)"
                             role="button" 
                             tabindex="0"
                             aria-label="Module <%= index + 1 %>: <%= module.titre %>"
                             onkeydown="if(event.key==='Enter'||event.key===' ') { this.click(); }">
                            
                            <div class="module-header">
                                <div class="module-title-group">
                                    <div class="module-number"><%= index + 1 %></div>
                                    <h3 class="module-title"><%= module.titre %></h3>
                                </div>
                                <div class="module-status <%= module.disponible ? 'available' : 'locked' %>">
                                    <%= module.disponible ? 'Disponible' : 'Verrouill√©' %>
                                </div>
                            </div>
                            
                            <p class="module-description">
                                <%= module.description || 'Description du module √† venir...' %>
                            </p>
                            
                            <div class="module-details">
                                <div class="module-detail">
                                    <span class="module-detail-icon">üé•</span>
                                    <span><%= module.type_contenu.charAt(0).toUpperCase() + module.type_contenu.slice(1) %> <%= module.duree_minutes || 0 %> min</span>
                                </div>
                                <div class="module-detail">
                                    <span class="module-detail-icon">üìÑ</span>
                                    <span>Ressources t√©l√©chargeables</span>
                                </div>
                                <% if (module.type_contenu === 'quiz' || module.type_contenu === 'evaluation') { %>
                                <div class="module-detail">
                                    <span class="module-detail-icon">‚ùì</span>
                                    <span>Quiz d'√©valuation</span>
                                </div>
                                <% } %>
                                <% if (formation.certifiant && index === formation.modules.length - 1) { %>
                                <div class="module-detail">
                                    <span class="module-detail-icon">üèÜ</span>
                                    <span>Certificat de r√©ussite</span>
                                </div>
                                <% } %>
                            </div>
                        </div>
                        <% }); %>
                    <% } else { %>
                        <div class="empty-state">
                            <div class="empty-icon">üìö</div>
                            <p>Les modules de cette formation seront bient√¥t disponibles.</p>
                            <p style="font-size: 0.9rem; margin-top: 0.5rem;">Inscrivez-vous pour √™tre notifi√© de leur publication.</p>
                        </div>
                    <% } %>
                </div>
            </div>

            <!-- Section avis -->
            <% if (formation.avis && formation.avis.length > 0) { %>
            <div class="reviews-section fade-in">
                <div class="reviews-header">
                    <div class="section-header" style="margin-bottom: 0;">
                        <div class="section-icon">üí¨</div>
                        <h2 class="section-title">Avis des apprenants</h2>
                    </div>
                    <div class="rating-overview">
                        <div class="rating-score"><%= formation.noteMoyenne || 0 %></div>
                        <div class="rating-details">
                            <div class="stars">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ</div>
                            <div class="rating-count"><%= formation.nombreAvis %> avis v√©rifi√©s</div>
                        </div>
                    </div>
                </div>

                <% formation.avis.forEach(avis => { %>
                <div class="review-item">
                    <div class="review-header">
                        <div class="reviewer-info">
                            <div class="reviewer-avatar">
                                <%= avis.nom_utilisateur.split(' ').map(n => n[0]).join('') %>
                            </div>
                            <div class="reviewer-details">
                                <h4><%= avis.nom_utilisateur %></h4>
                                <p class="reviewer-role"><%= avis.role %><%= avis.ville ? ` - ${avis.ville}` : '' %></p>
                            </div>
                        </div>
                        <div class="review-rating">
                            <% for (let i = 1; i <= 5; i++) { %>
                                <%= i <= avis.note ? '‚òÖ' : '‚òÜ' %>
                            <% } %>
                        </div>
                    </div>
                    <p class="review-text">"<%= avis.commentaire %>"</p>
                </div>
                <% }); %>
            </div>
            <% } %>

            <!-- Formations similaires -->
            <% if (formationsSimilaires && formationsSimilaires.length > 0) { %>
            <div class="similar-formations fade-in">
                <div class="section-header">
                    <div class="section-icon">üéØ</div>
                    <h2 class="section-title">Formations recommand√©es</h2>
                </div>
                <div class="similar-grid">
                    <% formationsSimilaires.forEach(f => { %>
                    <div class="similar-card" 
                         onclick="window.location.href='/formations/<%= f.id %>'"
                         role="button"
                         tabindex="0"
                         aria-label="Formation <%= f.titre %>"
                         onkeydown="if(event.key==='Enter'||event.key===' ') { this.click(); }">
                        <div class="similar-icon">
                            <%= f.icone || 'üìö' %>
                        </div>
                        <h3 class="similar-title"><%= f.titre %></h3>
                        <div class="similar-price">
                            <%= f.gratuit ? 'Gratuit' : Math.floor(f.prix) + '‚Ç¨' %>
                        </div>
                    </div>
                    <% }); %>
                </div>
            </div>
            <% } %>
        </div>

        <!-- Sidebar -->
        <div class="sidebar">
            <!-- Carte d'inscription -->
            <div class="purchase-card fade-in">
                <div class="price-section">
                    <% if (formation.gratuit) { %>
                    <span class="price-current">Gratuit</span>
                    <div class="price-badge free">üéâ Formation offerte</div>
                    <% } else { %>
                    <span class="price-current"><%= Math.floor(formation.prix) %>‚Ç¨</span>
                    <% if (formation.prix_original && formation.prix_original > formation.prix) { %>
                    <div style="font-size: 1.1rem; color: var(--text-light); text-decoration: line-through; margin-top: 0.5rem;">
                        <%= Math.floor(formation.prix_original) %>‚Ç¨
                    </div>
                    <div class="price-badge discount">
                        üí∞ √âconomisez <%= Math.floor(formation.prix_original - formation.prix) %>‚Ç¨
                    </div>
                    <% } %>
                    <% } %>
                </div>

                <ul class="features-list">
                    <li class="feature-item">
                        <div class="feature-check">‚úì</div>
                        <span>Acc√®s imm√©diat √† vie</span>
                    </li>
                    <li class="feature-item">
                        <div class="feature-check">‚úì</div>
                        <span><%= formation.nombre_modules %> modules interactifs</span>
                    </li>
                    <li class="feature-item">
                        <div class="feature-check">‚úì</div>
                        <span>Vid√©os HD professionnelles</span>
                    </li>
                    <li class="feature-item">
                        <div class="feature-check">‚úì</div>
                        <span>Ressources t√©l√©chargeables</span>
                    </li>
                    <li class="feature-item">
                        <div class="feature-check">‚úì</div>
                        <span>Quiz d'√©valuation</span>
                    </li>
                    <% if (formation.certifiant) { %>
                    <li class="feature-item">
                        <div class="feature-check">‚úì</div>
                        <span>Certificat de r√©ussite</span>
                    </li>
                    <% } %>
                    <li class="feature-item">
                        <div class="feature-check">‚úì</div>
                        <span>Support expert 24/7</span>
                    </li>
                    <li class="feature-item">
                        <div class="feature-check">‚úì</div>
                        <span>Acc√®s mobile & desktop</span>
                    </li>
                </ul>

                <div class="cta-buttons">
    <button class="btn btn-primary" 
            onclick="commencerFormation(<%= formation.id %>, '<%= formation.titre.replace(/'/g, "\\'") %>', <%= formation.prix || 0 %>, <%= formation.gratuit %>)"
            aria-label="Commencer la formation <%= formation.titre %>">
        üöÄ Commencer maintenant
    </button>
    <button class="btn btn-secondary" 
            onclick="voirProgramme()"
            aria-label="Voir le programme d√©taill√©">
        üìã Programme d√©taill√©
    </button>
    <!-- üîß CORRECTION: V√©rifier si user existe avant d'acc√©der √† ses propri√©t√©s -->
    <% if (typeof user !== 'undefined' && user && user.role === 'admin') { %>
    <a href="/admin/formations/<%= formation.id %>/modifier" class="btn btn-secondary">
        ‚úèÔ∏è Modifier (Admin)
    </a>
    <% } %>
</div>
            </div>

            <!-- Statistiques -->
            <div class="stats-card fade-in">
                <h3 style="color: var(--text-dark); margin-bottom: 1.5rem; display: flex; align-items: center; gap: 0.5rem;">
                    üìä Informations
                </h3>
                <div class="stats-grid">
                    <div class="stat-row">
                        <span class="stat-label">Domaine</span>
                        <span class="stat-value" style="color: var(--primary-pink); text-transform: capitalize;">
                            <%= formation.domaine %>
                        </span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Dur√©e totale</span>
                        <span class="stat-value" style="color: var(--primary-blue);">
                            <%= formation.duree_heures %>h
                        </span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Modules</span>
                        <span class="stat-value" style="color: var(--primary-pink);">
                            <%= formation.nombre_modules %>
                        </span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Niveau</span>
                        <span class="stat-value" style="text-transform: capitalize;">
                            <%= formation.niveau %>
                        </span>
                    </div>
                    <% if (formation.nombreAvis > 0) { %>
                    <div class="stat-row">
                        <span class="stat-label">Note moyenne</span>
                        <span class="stat-value" style="color: var(--success);">
                            <%= formation.noteMoyenne %>/5
                        </span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Avis</span>
                        <span class="stat-value">
                            <%= formation.nombreAvis %>
                        </span>
                    </div>
                    <% } %>
                    <div class="stat-row">
                        <span class="stat-label">Derni√®re MAJ</span>
                        <span class="stat-value">
                            <%= new Date(formation.updatedAt).toLocaleDateString('fr-FR') %>
                        </span>
                    </div>
                </div>
            </div>

            <!-- Support -->
            <div class="stats-card fade-in" style="background: linear-gradient(135deg, var(--light-blue), var(--light-pink)); border: 1px solid var(--primary-blue);">
                <h3 style="color: var(--primary-blue); margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                    üí¨ Besoin d'aide ?
                </h3>
                <p style="color: var(--text-dark); margin-bottom: 1.5rem; font-size: 0.9rem; line-height: 1.5;">
                    Notre √©quipe est l√† pour vous accompagner dans votre parcours de formation.
                </p>
                <button class="btn btn-secondary" 
                        onclick="ouvrirSupport()"
                        style="width: 100%;"
                        aria-label="Contacter le support">
                    üìû Contacter le support
                </button>
            </div>
        </div>
    </div>

    <%- include('../partials/footer') %>

    <script>
        // Gestionnaire d'animations au scroll
        class ScrollAnimator {
            constructor() {
                this.observer = new IntersectionObserver(
                    (entries) => this.handleIntersection(entries),
                    { threshold: 0.1, rootMargin: '0px 0px -50px 0px' }
                );
                this.init();
            }

            init() {
                document.querySelectorAll('.fade-in').forEach(el => {
                    this.observer.observe(el);
                });
            }

            handleIntersection(entries) {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        entry.target.classList.add('visible');
                        this.observer.unobserve(entry.target);
                    }
                });
            }
        }

        // Gestionnaire de la formation
        class FormationManager {
            constructor() {
                this.formationId = <%= formation.id %>;
                this.formationTitle = '<%= formation.titre.replace(/'/g, "\\'") %>';
                this.modules = [
                    <% if (formation.modules && formation.modules.length > 0) { %>
                        <% formation.modules.forEach((module, index) => { %>
                            {
                                id: <%= module.id %>,
                                title: '<%= module.titre.replace(/'/g, "\\'") %>',
                                duration: <%= module.duree_minutes || 0 %>,
                                available: <%= module.disponible %>,
                                order: <%= index + 1 %>
                            }<%= index < formation.modules.length - 1 ? ',' : '' %>
                        <% }); %>
                    <% } %>
                ];
            }

            generateProgramDetails() {
                let programText = `üìã Programme d√©taill√© - ${this.formationTitle}\n\n`;
                
                if (this.modules.length > 0) {
                    programText += `üìö ${this.modules.length} modules :\n\n`;
                    this.modules.forEach(module => {
                        const status = module.available ? '‚úÖ' : 'üîí';
                        programText += `${status} Module ${module.order}: ${module.title}`;
                        if (module.duration > 0) {
                            programText += ` (${module.duration} min)`;
                        }
                        programText += '\n';
                    });
                    programText += '\nüìÑ Ressources t√©l√©chargeables incluses';
                    <% if (formation.certifiant) { %>
                    programText += '\nüèÜ Certificat de r√©ussite √† la fin';
                    <% } %>
                } else {
                    programText += 'Programme en cours de finalisation.\n';
                    programText += 'Les modules seront bient√¥t disponibles.\n\n';
                    programText += 'üí° Inscrivez-vous pour √™tre notifi√© !';
                }
                
                return programText;
            }

            showLoadingState(button) {
                if (button) {
                    button.classList.add('loading');
                    button.disabled = true;
                    const originalText = button.innerHTML;
                    button.setAttribute('data-original', originalText);
                    button.innerHTML = originalText.replace(/üöÄ|üìã|üìû/, '‚è≥');
                }
            }

            hideLoadingState(button) {
                if (button) {
                    button.classList.remove('loading');
                    button.disabled = false;
                    const originalText = button.getAttribute('data-original');
                    if (originalText) {
                        button.innerHTML = originalText;
                    }
                }
            }
        }

        // Fonctions globales
        function commencerFormation(id, titre, prix, gratuit) {
            const button = event.target;
            const manager = new FormationManager();
            
            manager.showLoadingState(button);
            
            // Simulation d'un d√©lai de traitement
            setTimeout(() => {
                if (gratuit) {
                    const confirmed = confirm(
                        `üéâ D√©marrer la formation gratuite ?\n\n` +
                        `"${titre}"\n\n` +
                        `‚úÖ Acc√®s imm√©diat √† tous les modules\n` +
                        `üì± Compatible mobile et desktop\n` +
                        `üèÜ Certificat de r√©ussite inclus\n\n` +
                        `Commencer maintenant ?`
                    );
                    
                    if (confirmed) {
                        // Redirection vers la premi√®re le√ßon ou tableau de bord
                        window.location.href = `/formations/${id}/commencer`;
                    }
                } else {
                    const confirmed = confirm(
                        `üí≥ Inscription √† la formation\n\n` +
                        `"${titre}"\n` +
                        `Prix : ${prix}‚Ç¨\n\n` +
                        `‚úÖ Acc√®s √† vie\n` +
                        `üîí Paiement s√©curis√©\n` +
                        `‚Ü©Ô∏è Garantie satisfait ou rembours√©\n\n` +
                        `Proc√©der au paiement ?`
                    );
                    
                    if (confirmed) {
                        // Redirection vers la page de paiement
                        window.location.href = `/formations/${id}/acheter`;
                    }
                }
                
                manager.hideLoadingState(button);
            }, 1000);
        }

        function voirProgramme() {
            const manager = new FormationManager();
            const programDetails = manager.generateProgramDetails();
            alert(programDetails);
        }

        function ouvrirModule(moduleId, titre, disponible) {
            if (disponible) {
                const confirmed = confirm(
                    `üìö Acc√©der au module\n\n` +
                    `"${titre}"\n\n` +
                    `‚ñ∂Ô∏è Commencer la lecture ?\n` +
                    `üí° Votre progression sera sauvegard√©e`
                );
                
                if (confirmed) {
                    // Redirection vers le module
                    window.location.href = `/formations/<%= formation.id %>/modules/${moduleId}`;
                }
            } else {
                alert(
                    `üîí Module verrouill√©\n\n` +
                    `"${titre}"\n\n` +
                    `üí° Inscrivez-vous √† la formation pour acc√©der √† ce contenu.\n\n` +
                    `‚úÖ Acc√®s imm√©diat apr√®s inscription\n` +
                    `üì± Disponible sur tous vos appareils`
                );
            }
        }

        function ouvrirSupport() {
            const supportMessage = 
                `üí¨ Support ADSIAM\n\n` +
                `üéØ Formation : "<%= formation.titre %>"\n\n` +
                `Comment pouvons-nous vous aider ?\n\n` +
                `üìß Email : support@adsiam.org\n` +
                `üìû T√©l√©phone : 06 50 84 81 75\n` +
                `üí¨ Chat en direct disponible\n\n` +
                `‚è∞ Disponible 7j/7 de 9h √† 19h`;
            
            const openSupport = confirm(supportMessage + '\n\nOuvrir le chat support ?');
            
            if (openSupport) {
                // Ici vous pourriez ouvrir votre widget de chat ou rediriger vers la page contact
                window.open('/contact?formation=<%= formation.id %>', '_blank');
            }
        }

        // Gestion du clavier pour l'accessibilit√©
        document.addEventListener('keydown', function(e) {
            // √âchap pour fermer les modales/alertes
            if (e.key === 'Escape') {
                // Fermer toute modal ouverte
                const modals = document.querySelectorAll('[role="dialog"]');
                modals.forEach(modal => modal.style.display = 'none');
            }
        });

        // Gestion des erreurs JavaScript
        window.addEventListener('error', function(e) {
            console.error('Erreur JavaScript:', e.error);
            // En production, vous pourriez envoyer ces erreurs √† un service de monitoring
        });

        // Analytics et suivi
        function trackEvent(action, details = {}) {
            console.log(`üìä Event: ${action}`, details);
            // Ici vous pourriez envoyer √† Google Analytics, Mixpanel, etc.
            
            // Exemple pour Google Analytics 4
            if (typeof gtag !== 'undefined') {
                gtag('event', action, {
                    formation_id: <%= formation.id %>,
                    formation_title: '<%= formation.titre.replace(/'/g, "\\'") %>',
                    ...details
                });
            }
        }

        // Suivi des interactions importantes
        document.addEventListener('click', function(e) {
            if (e.target.matches('.btn-primary')) {
                trackEvent('formation_start_clicked', {
                    formation_price: <%= formation.prix || 0 %>,
                    is_free: <%= formation.gratuit %>
                });
            } else if (e.target.matches('.module-item')) {
                const moduleTitle = e.target.querySelector('.module-title')?.textContent;
                trackEvent('module_clicked', {
                    module_title: moduleTitle
                });
            }
        });

        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            // Initialiser les animations
            new ScrollAnimator();
            
            // Suivi du temps pass√© sur la page
            const startTime = Date.now();
            
            window.addEventListener('beforeunload', function() {
                const timeSpent = Math.round((Date.now() - startTime) / 1000);
                trackEvent('page_view_duration', {
                    duration_seconds: timeSpent
                });
            });

            // Suivi de la progression de lecture
            let maxScroll = 0;
            window.addEventListener('scroll', function() {
                const scrollPercent = Math.round(
                    (window.scrollY / (document.body.scrollHeight - window.innerHeight)) * 100
                );
                
                if (scrollPercent > maxScroll && scrollPercent % 25 === 0) {
                    maxScroll = scrollPercent;
                    trackEvent('scroll_depth', {
                        percent: scrollPercent
                    });
                }
            });

            // D√©tection mobile pour ajustements UX
            const isMobile = window.innerWidth < 768;
            if (isMobile) {
                document.body.classList.add('mobile');
                
                // Ajuster le comportement du sticky sur mobile
                const purchaseCard = document.querySelector('.purchase-card');
                if (purchaseCard) {
                    purchaseCard.style.position = 'static';
                }
            }

            console.log('üìö Formation "<%= formation.titre %>" charg√©e');
            console.log('üéØ Domaine: <%= formation.domaine %>');
            console.log('‚è±Ô∏è Dur√©e: <%= formation.duree_heures %> heures');
            console.log('üìù Modules: <%= formation.nombre_modules %>');
            
            trackEvent('formation_page_viewed', {
                formation_domain: '<%= formation.domaine %>',
                formation_level: '<%= formation.niveau %>',
                is_mobile: isMobile
            });
        });

        // Optimisations des performances
        if ('requestIdleCallback' in window) {
            requestIdleCallback(() => {
                // Pr√©charger les images des formations similaires
                <% if (formationsSimilaires && formationsSimilaires.length > 0) { %>
                const preloadImages = [
                    // Ajouter ici les URLs des images si vous en avez
                ];
                preloadImages.forEach(url => {
                    const link = document.createElement('link');
                    link.rel = 'prefetch';
                    link.href = url;
                    document.head.appendChild(link);
                });
                <% } %>
            });
        }
    </script>

    <!-- Schema.org pour le SEO -->
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "Course",
        "name": "<%= formation.titre %>",
        "description": "<%= formation.description %>",
        "provider": {
            "@type": "Organization",
            "name": "ADSIAM",
            "url": "https://adsiam.org"
        },
        <% if (!formation.gratuit) { %>
        "offers": {
            "@type": "Offer",
            "price": "<%= formation.prix %>",
            "priceCurrency": "EUR"
        },
        <% } %>
        "courseMode": "online",
        "educationalLevel": "<%= formation.niveau %>",
        "timeRequired": "PT<%= formation.duree_heures %>H",
        "numberOfCredits": "<%= formation.nombre_modules %>",
        <% if (formation.nombreAvis > 0) { %>
        "aggregateRating": {
            "@type": "AggregateRating",
            "ratingValue": "<%= formation.noteMoyenne %>",
            "reviewCount": "<%= formation.nombreAvis %>"
        },
        <% } %>
        "hasCourseInstance": {
            "@type": "CourseInstance",
            "courseMode": "online",
            "instructor": {
                "@type": "Organization",
                "name": "ADSIAM"
            }
        }
    }
    </script>

    
</body>
</html>