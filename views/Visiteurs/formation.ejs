<!-- views/visiteurs/formation.ejs -->
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= formation.titre %> | ADSIAM - Formation D√©taill√©e</title>
    <link rel="stylesheet" href="/css/formation.css">
</head>
<body>
    <%- include('../partials/header') %>
    <%- include('../partials/breadcrumb', { breadcrumb: [{ name: 'Formations', url: '/formations' }, { name: formation.titre }] }) %>

    <div class="main-content">
        <!-- Left Column - Course Content -->
        <div class="content-column">
            <!-- Formation Header -->
            <div class="formation-header fade-in">
                <div class="formation-hero">
                    <div class="formation-info">
                        <h1><%= formation.titre %></h1>
                        <p class="formation-subtitle">Formation <%= formation.niveau %> ‚Ä¢ <%= formation.duree_heures %> heures ‚Ä¢ <%= formation.nombre_modules %> modules</p>
                        <p class="formation-description"><%= formation.description %></p>
                        <div class="formation-meta">
                            <div class="meta-badge level">
                                üìö Niveau <%= formation.niveau %>
                            </div>
                            <div class="meta-badge duration">
                                ‚è±Ô∏è <%= formation.duree_heures %> heures
                            </div>
                            <div class="meta-badge modules">
                                üéØ <%= formation.nombre_modules %> modules
                            </div>
                            <% if (formation.nombreAvis > 0) { %>
                            <div class="meta-badge rating">
                                ‚≠ê <%= formation.noteMoyenne %>/5 (<%= formation.nombreAvis %> avis)
                            </div>
                            <% } %>
                        </div>
                    </div>
                    <div class="formation-icon-large">
                        <%= formation.icone %>
                    </div>
                </div>
            </div>

            <!-- Course Content -->
            <div class="course-content fade-in">
                <h2 class="section-title">
                    <div class="section-icon">üìã</div>
                    Contenu de la formation
                </h2>
                <div class="modules-list">
                    <% formation.modules.forEach((module, index) => { %>
                    <div class="module-item">
                        <div class="module-header">
                            <div class="module-title">
                                <div class="module-number"><%= index + 1 %></div>
                                <%= module.titre %>
                            </div>
                            <div class="module-status <%= module.disponible ? 'available' : 'locked' %>">
                                <%= module.disponible ? 'Disponible' : 'Verrouill√©' %>
                            </div>
                        </div>
                        <p class="module-description"><%= module.description %></p>
                        <div class="module-details">
                            <div class="module-detail">
                                <span class="detail-icon">üé•</span>
                                <span><%= module.type_contenu.charAt(0).toUpperCase() + module.type_contenu.slice(1) %> <%= module.duree_minutes %> min</span>
                            </div>
                            <div class="module-detail">
                                <span class="detail-icon">üìÑ</span>
                                <span>PDF t√©l√©chargeable</span>
                            </div>
                            <% if (module.type_contenu === 'quiz') { %>
                            <div class="module-detail">
                                <span class="detail-icon">‚ùì</span>
                                <span>Quiz d'√©valuation</span>
                            </div>
                            <% } %>
                        </div>
                    </div>
                    <% }); %>
                </div>
            </div>

            <!-- Reviews Section -->
            <% if (formation.avis && formation.avis.length > 0) { %>
            <div class="reviews-section fade-in">
                <div class="reviews-header">
                    <h2 class="section-title">
                        <div class="section-icon">üí¨</div>
                        Avis des apprenants
                    </h2>
                    <div class="rating-overview">
                        <div class="rating-score"><%= formation.noteMoyenne %></div>
                        <div class="rating-details">
                            <div class="stars">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ</div>
                            <div class="rating-count"><%= formation.nombreAvis %> avis v√©rifi√©s</div>
                        </div>
                    </div>
                </div>

                <% formation.avis.forEach(avis => { %>
                <div class="review-item">
                    <div class="review-header">
                        <div class="reviewer-info">
                            <div class="reviewer-avatar"><%= avis.nom_utilisateur.split(' ').map(n => n[0]).join('') %></div>
                            <div class="reviewer-details">
                                <h4><%= avis.nom_utilisateur %></h4>
                                <div class="role"><%= avis.role %><%= avis.ville ? ` - ${avis.ville}` : '' %></div>
                            </div>
                        </div>
                        <div class="review-rating">
                            <% for (let i = 1; i <= 5; i++) { %>
                                <%= i <= avis.note ? '‚òÖ' : '‚òÜ' %>
                            <% } %>
                        </div>
                    </div>
                    <p class="review-text">"<%= avis.commentaire %>"</p>
                </div>
                <% }); %>
            </div>
            <% } %>

            <!-- Related Courses -->
            <% if (formationsSimilaires && formationsSimilaires.length > 0) { %>
            <div class="related-courses fade-in">
                <h2 class="section-title">
                    <div class="section-icon">üéØ</div>
                    Formations recommand√©es
                </h2>
                <div class="related-grid">
                    <% formationsSimilaires.forEach(f => { %>
                    <div class="related-course" onclick="window.location.href='/formations/<%= f.id %>'">
                        <div class="related-icon"><%= f.icone %></div>
                        <h3 class="related-title"><%= f.titre %></h3>
                        <div class="related-price">
                            <%= f.gratuit ? 'Gratuit' : Math.floor(f.prix) + '‚Ç¨' %>
                        </div>
                    </div>
                    <% }); %>
                </div>
            </div>
            <% } %>
        </div>

        <!-- Right Sidebar -->
        <div class="sidebar">
            <!-- Purchase Card -->
            <div class="purchase-card fade-in">
                <div class="price-section">
                    <% if (formation.gratuit) { %>
                    <span class="price-current">Gratuit</span>
                    <div class="price-save">üéâ Formation offerte</div>
                    <% } else { %>
                    <span class="price-current"><%= Math.floor(formation.prix) %>‚Ç¨</span>
                    <% if (formation.prix_original) { %>
                    <div class="price-original"><%= Math.floor(formation.prix_original) %>‚Ç¨</div>
                    <div class="price-save">üí∞ √âconomisez <%= Math.floor(formation.prix_original - formation.prix) %>‚Ç¨</div>
                    <% } %>
                    <% } %>
                </div>

                <div class="purchase-features">
                    <ul class="feature-list">
                        <li class="feature-item">
                            <div class="feature-icon">‚úì</div>
                            <span>Acc√®s imm√©diat √† vie</span>
                        </li>
                        <li class="feature-item">
                            <div class="feature-icon">‚úì</div>
                            <span><%= formation.nombre_modules %> modules interactifs</span>
                        </li>
                        <li class="feature-item">
                            <div class="feature-icon">‚úì</div>
                            <span>Vid√©os HD professionnelles</span>
                        </li>
                        <li class="feature-item">
                            <div class="feature-icon">‚úì</div>
                            <span>PDF t√©l√©chargeables</span>
                        </li>
                        <li class="feature-item">
                            <div class="feature-icon">‚úì</div>
                            <span>Quiz d'√©valuation</span>
                        </li>
                        <% if (formation.certifiant) { %>
                        <li class="feature-item">
                            <div class="feature-icon">‚úì</div>
                            <span>Certificat de r√©ussite</span>
                        </li>
                        <% } %>
                        <li class="feature-item">
                            <div class="feature-icon">‚úì</div>
                            <span>Support 7j/7</span>
                        </li>
                    </ul>
                </div>

                <div class="cta-buttons">
                    <button class="btn btn-primary" onclick="commencerFormation(<%= formation.id %>, '<%= formation.titre %>', <%= formation.prix %>, <%= formation.gratuit %>)">
                        üöÄ Commencer maintenant
                    </button>
                    <button class="btn btn-secondary" onclick="voirProgramme()">
                        üìã Programme d√©taill√©
                    </button>
                </div>
            </div>

            <!-- Stats -->
            <div class="instructor-card fade-in">
                <h3 class="instructor-name">üìä Statistiques</h3>
                <div style="display: flex; flex-direction: column; gap: 1rem; margin-top: 1.5rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span>üë• Domaine</span>
                        <strong style="color: var(--primary-pink); text-transform: capitalize;"><%= formation.domaine %></strong>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span>‚è±Ô∏è Dur√©e totale</span>
                        <strong style="color: var(--primary-blue);"><%= formation.duree_heures %>h</strong>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span>üéØ Modules</span>
                        <strong style="color: var(--primary-pink);"><%= formation.nombre_modules %></strong>
                    </div>
                    <% if (formation.nombreAvis > 0) { %>
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span>‚≠ê Note moyenne</span>
                        <strong style="color: var(--success);"><%= formation.noteMoyenne %>/5</strong>
                    </div>
                    <% } %>
                </div>
            </div>
        </div>
    </div>

    <%- include('../partials/footer') %>
    <%- include('../partials/chat-widget') %>

    <script>
        function commencerFormation(id, titre, prix, gratuit) {
            if (gratuit) {
                alert(`üéâ F√©licitations !\n\n‚úÖ Acc√®s imm√©diat √† la formation :\n"${titre}"\n\nüöÄ Redirection vers le premier module...`);
            } else {
                alert(`üí≥ Formation : ${titre}\nPrix : ${prix}‚Ç¨\n\nüõí Redirection vers le paiement s√©curis√©...`);
            }
        }

        function voirProgramme() {
            alert('üìã Programme d√©taill√©\n\n<%= formation.modules.map((m, i) => `Module ${i+1}: ${m.titre} (${m.duree_minutes} min)`).join('\\n') %>\n\nüìÑ Programme complet t√©l√©chargeable apr√®s inscription');
        }

        // Animation au scroll
        const observerOptions = {
            threshold: 0.1,
            rootMargin: '0px 0px -50px 0px'
        };

        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    entry.target.style.animation = 'fadeInUp 0.8s ease forwards';
                }
            });
        }, observerOptions);

        document.querySelectorAll('.fade-in').forEach(el => {
            observer.observe(el);
        });

        console.log('üìö Formation "<%= formation.titre %>" charg√©e');
    </script>
</body>
</html>