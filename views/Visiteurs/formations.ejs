<!-- views/visiteurs/formations.ejs -->
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Catalogue Formations | ADSIAM - Aide √† Domicile & EHPAD</title>
    <link rel="stylesheet" href="/css/formations.css">
</head>
<body>
    <%- include('../partials/header', { currentPage: 'formations' }) %>
    <%- include('../partials/breadcrumb', { breadcrumb: [{ name: 'Catalogue des formations', url: '/formations' }] }) %>

    <main>
        <!-- Hero Section -->
        <section class="hero">
            <div class="hero-container">
                <div class="hero-badge">üìö Catalogue Complet</div>
                <h1>Toutes nos <span class="hero-highlight">Formations</span></h1>
                <p>D√©couvrez notre catalogue complet de formations professionnelles pour l'aide √† domicile et les EHPAD. Des formations interactives et adapt√©es aux r√©alit√©s du terrain.</p>
            </div>
        </section>

        <!-- Search & Filters Section -->
        <section class="search-section">
            <div class="search-header">
                <h2 class="search-title">Trouvez votre formation id√©ale</h2>
                <p class="search-subtitle">Utilisez les filtres ci-dessous pour affiner votre recherche</p>
            </div>

            <form method="GET" action="/formations">
                <div class="search-bar">
                    <input type="text" name="recherche" class="search-input" 
                           placeholder="Rechercher une formation..." 
                           value="<%= filtres.recherche || '' %>">
                    <button type="submit" class="search-icon">üîç</button>
                </div>

                <div class="filters-container">
                    <div class="filter-group">
                        <label class="filter-label">Niveau</label>
                        <select name="niveau" class="filter-select">
                            <option value="">Tous les niveaux</option>
                            <option value="debutant" <%= filtres.niveau === 'debutant' ? 'selected' : '' %>>D√©butant</option>
                            <option value="intermediaire" <%= filtres.niveau === 'intermediaire' ? 'selected' : '' %>>Interm√©diaire</option>
                            <option value="avance" <%= filtres.niveau === 'avance' ? 'selected' : '' %>>Avanc√©</option>
                            <option value="expert" <%= filtres.niveau === 'expert' ? 'selected' : '' %>>Expert</option>
                        </select>
                    </div>

                    <div class="filter-group">
                        <label class="filter-label">Dur√©e</label>
                        <select name="duree" class="filter-select">
                            <option value="">Toutes les dur√©es</option>
                            <option value="courte" <%= filtres.duree === 'courte' ? 'selected' : '' %>>1-3 modules</option>
                            <option value="moyenne" <%= filtres.duree === 'moyenne' ? 'selected' : '' %>>4-6 modules</option>
                            <option value="longue" <%= filtres.duree === 'longue' ? 'selected' : '' %>>7+ modules</option>
                        </select>
                    </div>

                    <div class="filter-group">
                        <label class="filter-label">Prix</label>
                        <select name="prix" class="filter-select">
                            <option value="">Tous les prix</option>
                            <option value="gratuit" <%= filtres.prix === 'gratuit' ? 'selected' : '' %>>Gratuit</option>
                            <option value="payant" <%= filtres.prix === 'payant' ? 'selected' : '' %>>Payant</option>
                        </select>
                    </div>

                    <div class="filter-group">
                        <label class="filter-label">Domaine</label>
                        <select name="domaine" class="filter-select">
                            <option value="">Tous les domaines</option>
                            <option value="communication" <%= filtres.domaine === 'communication' ? 'selected' : '' %>>Communication</option>
                            <option value="hygiene" <%= filtres.domaine === 'hygiene' ? 'selected' : '' %>>Hygi√®ne & S√©curit√©</option>
                            <option value="ergonomie" <%= filtres.domaine === 'ergonomie' ? 'selected' : '' %>>Ergonomie</option>
                            <option value="urgences" <%= filtres.domaine === 'urgences' ? 'selected' : '' %>>Urgences</option>
                            <option value="nutrition" <%= filtres.domaine === 'nutrition' ? 'selected' : '' %>>Nutrition</option>
                            <option value="pathologies" <%= filtres.domaine === 'pathologies' ? 'selected' : '' %>>Pathologies</option>
                        </select>
                    </div>
                </div>

                <div class="filter-actions">
                    <button type="submit" class="btn btn-primary">Appliquer les filtres</button>
                    <a href="/formations" class="btn btn-secondary">R√©initialiser</a>
                </div>
            </form>
        </section>

        <!-- Results Section -->
        <section class="results-section">
            <div class="results-header">
                <div class="results-info">
                    <span class="results-count"><%= pagination.totalFormations %> formation<%= pagination.totalFormations > 1 ? 's' : '' %> trouv√©e<%= pagination.totalFormations > 1 ? 's' : '' %></span>
                    <span class="results-badge">Toutes disponibles</span>
                </div>
                <div class="view-controls">
                    <form method="GET" action="/formations" style="display: inline;">
                        <% Object.keys(filtres).forEach(key => { %>
                            <% if (filtres[key] && key !== 'tri') { %>
                            <input type="hidden" name="<%= key %>" value="<%= filtres[key] %>">
                            <% } %>
                        <% }); %>
                        <select name="tri" class="sort-select" onchange="this.form.submit()">
                            <option value="populaire" <%= filtres.tri === 'populaire' ? 'selected' : '' %>>Trier par popularit√©</option>
                            <option value="prix_croissant" <%= filtres.tri === 'prix_croissant' ? 'selected' : '' %>>Prix croissant</option>
                            <option value="prix_decroissant" <%= filtres.tri === 'prix_decroissant' ? 'selected' : '' %>>Prix d√©croissant</option>
                            <option value="niveau" <%= filtres.tri === 'niveau' ? 'selected' : '' %>>Niveau</option>
                            <option value="duree" <%= filtres.tri === 'duree' ? 'selected' : '' %>>Dur√©e</option>
                        </select>
                    </form>
                </div>
            </div>

            <!-- Formations Grid -->
            <div class="formations-grid">
                <% formations.forEach(formation => { %>
                <div class="formation-card fade-in" onclick="window.location.href='/formations/<%= formation.id %>'">
                    <div class="formation-header">
                        <div class="formation-icon"><%= formation.icone %></div>
                        <% if (formation.badge) { %>
                        <div class="formation-badge"><%= formation.badge %></div>
                        <% } %>
                    </div>
                    <div class="formation-content">
                        <div class="formation-meta">
                            <span class="meta-tag modules-tag"><%= formation.nombre_modules %> modules</span>
                            <span class="meta-tag level-tag"><%= formation.niveau.charAt(0).toUpperCase() + formation.niveau.slice(1) %></span>
                            <span class="meta-tag duration-tag"><%= formation.duree_heures %>h</span>
                            <% if (formation.nombreAvis > 0) { %>
                            <span class="meta-tag rating-tag">‚≠ê <%= formation.noteMoyenne %>/5</span>
                            <% } %>
                        </div>
                        <h3 class="formation-title"><%= formation.titre %></h3>
                        <p class="formation-description"><%= formation.description %></p>
                        <div class="formation-features">
                            <% formation.caracteristiques.slice(0, 4).forEach(carac => { %>
                            <div class="feature-item">
                                <span class="feature-icon"><%= carac.icone %></span>
                                <span><%= carac.titre %></span>
                            </div>
                            <% }); %>
                        </div>
                        <div class="formation-footer">
                            <div class="formation-price">
                                <% if (formation.gratuit) { %>
                                <span class="price-current">Gratuit</span>
                                <% } else { %>
                                <span class="price-current"><%= Math.floor(formation.prix) %>‚Ç¨</span>
                                <% if (formation.prix_original) { %>
                                <span class="price-original"><%= Math.floor(formation.prix_original) %>‚Ç¨</span>
                                <% } %>
                                <% } %>
                            </div>
                            <button class="formation-btn" onclick="event.stopPropagation(); window.location.href='/formations/<%= formation.id %>'">
                                Commencer
                            </button>
                        </div>
                    </div>
                </div>
                <% }); %>
            </div>

            <!-- Pagination -->
            <% if (pagination.totalPages > 1) { %>
            <div class="pagination">
                <% if (pagination.page > 1) { %>
                <a href="/formations?page=<%= pagination.page - 1 %><%= Object.keys(filtres).map(key => filtres[key] && key !== 'page' ? `&${key}=${filtres[key]}` : '').join('') %>" class="pagination-btn">‚Äπ Pr√©c√©dent</a>
                <% } %>
                
                <% for (let i = Math.max(1, pagination.page - 2); i <= Math.min(pagination.totalPages, pagination.page + 2); i++) { %>
                <a href="/formations?page=<%= i %><%= Object.keys(filtres).map(key => filtres[key] && key !== 'page' ? `&${key}=${filtres[key]}` : '').join('') %>" 
                   class="pagination-btn <%= i === pagination.page ? 'active' : '' %>"><%= i %></a>
                <% } %>
                
                <% if (pagination.page < pagination.totalPages) { %>
                <a href="/formations?page=<%= pagination.page + 1 %><%= Object.keys(filtres).map(key => filtres[key] && key !== 'page' ? `&${key}=${filtres[key]}` : '').join('') %>" class="pagination-btn">Suivant ‚Ä∫</a>
                <% } %>
            </div>
            <% } %>
        </section>
    </main>

    <%- include('../partials/footer') %>
    <%- include('../partials/chat-widget') %>

    <script>
        // Animation au scroll
        const observerOptions = {
            threshold: 0.1,
            rootMargin: '0px 0px -50px 0px'
        };

        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    entry.target.style.animation = 'fadeInUp 0.8s ease forwards';
                }
            });
        }, observerOptions);

        document.querySelectorAll('.fade-in').forEach(el => {
            observer.observe(el);
        });

        console.log('üìö Catalogue formations charg√©');
        console.log(`üîç <%= pagination.totalFormations %> formations trouv√©es`);
    </script>
</body>
</html>
